<div class="ux-page">
  <!-- Sidebar -->
  <app-sidebar class="ux-sidebar"></app-sidebar>

  <!-- Main -->
  <div class="ux-main">
    <!-- Header -->
    <header class="ux-header">
      <div class="ux-header__title">
        <h1>{{ seguimientoId ? 'Editar Seguimiento de Levante' : 'Nuevo Seguimiento de Levante' }}</h1>

        <div class="ux-header__meta">
          <!-- Si hay lote seleccionado -->
          <ng-container *ngIf="form.get('loteId')?.value as lid; else noLoteChip">
            <span class="chip chip--info">
              <span class="chip__dot"></span>
              Lote: {{ lotesById[lid]?.loteNombre || lid }}
            </span>
            <span class="chip chip--muted">
              {{ calcularEdadSemanas(lotesById[lid]?.fechaEncaset) }} sem
            </span>
          </ng-container>

          <!-- Si NO hay lote -->
          <ng-template #noLoteChip>
            <span class="chip chip--warning">
              <span class="chip__dot"></span>
              Selecciona un lote para continuar
            </span>
          </ng-template>
        </div>
      </div>

      <button
        type="submit"
        form="seguimientoForm"
        class="btn btn--primary"
        [disabled]="loading || form.invalid"
        [title]="form.invalid ? 'Completa los campos requeridos' : 'Guardar'"
      >
        {{ loading ? 'Guardando…' : 'Guardar' }}
      </button>
    </header>

    <!-- Card/Form -->
    <section class="ux-card">
      <form
        [formGroup]="form"
        (ngSubmit)="save()"
        id="seguimientoForm"
        class="ux-form"
        novalidate
      >
        <!-- Selección de lote y fecha -->
        <div class="grid grid-2">
          <div class="form-field">
            <label for="fechaRegistro">Fecha <span class="req">*</span></label>
            <input
              id="fechaRegistro"
              type="date"
              formControlName="fechaRegistro"
              [attr.aria-invalid]="form.get('fechaRegistro')?.invalid && form.get('fechaRegistro')?.touched ? 'true' : null"
            />
            <small class="field-error" *ngIf="form.get('fechaRegistro')?.invalid && form.get('fechaRegistro')?.touched">
              Obligatorio.
            </small>
          </div>

          <div class="form-field">
            <label for="loteId">Lote <span class="req">*</span></label>
            <div class="ux-select">
              <select
                id="loteId"
                formControlName="loteId"
                [attr.aria-invalid]="form.get('loteId')?.invalid && form.get('loteId')?.touched ? 'true' : null"
              >
                <option value="" disabled>— Selecciona un lote —</option>
                <option *ngFor="let l of lotes" [ngValue]="l.loteId">
                  {{ l.loteNombre }}
                </option>
              </select>
            </div>

            <!-- Edad del lote SIN funciones flecha -->
            <small class="field-hint" *ngIf="form.get('loteId')?.valid">
              Edad: {{ calcularEdadSemanas(lotesById[form.value.loteId].fechaEncaset ?? '') || '—' }} sem
            </small>

            <small class="field-error" *ngIf="form.get('loteId')?.invalid && form.get('loteId')?.touched">
              Obligatorio.
            </small>
          </div>
        </div>

        <!-- Mortalidad -->
        <h3 class="section-title">Mortalidad</h3>
        <div class="grid grid-2">
          <div class="form-field">
            <label for="mortalidadHembras">Hembras <span class="req">*</span></label>
            <input id="mortalidadHembras" type="number" min="0" formControlName="mortalidadHembras" />
          </div>
          <div class="form-field">
            <label for="mortalidadMachos">Machos <span class="req">*</span></label>
            <input id="mortalidadMachos" type="number" min="0" formControlName="mortalidadMachos" />
          </div>
        </div>

        <!-- Selección -->
        <h3 class="section-title">Selección</h3>
        <div class="grid grid-2">
          <div class="form-field">
            <label for="selH">Hembras <span class="req">*</span></label>
            <input id="selH" type="number" min="0" formControlName="selH" />
          </div>
          <div class="form-field">
            <label for="selM">Machos <span class="req">*</span></label>
            <input id="selM" type="number" min="0" formControlName="selM" />
          </div>
        </div>

        <!-- Error de sexaje -->
        <h3 class="section-title">Error de sexaje</h3>
        <div class="grid grid-2">
          <div class="form-field">
            <label for="errorSexajeHembras">Hembras <span class="req">*</span></label>
            <input id="errorSexajeHembras" type="number" min="0" formControlName="errorSexajeHembras" />
          </div>
          <div class="form-field">
            <label for="errorSexajeMachos">Machos <span class="req">*</span></label>
            <input id="errorSexajeMachos" type="number" min="0" formControlName="errorSexajeMachos" />
          </div>
        </div>

        <!-- Alimentación -->
        <h3 class="section-title">Alimentación</h3>
        <div class="grid grid-2">
          <div class="form-field">
            <label for="tipoAlimento">Tipo de alimento <span class="req">*</span></label>
            <input id="tipoAlimento" type="text" formControlName="tipoAlimento" />
          </div>
          <div class="form-field">
            <label for="consumoKgHembras">Consumo (Kg Hembras) <span class="req">*</span></label>
            <input id="consumoKgHembras" type="number" step="0.01" min="0" formControlName="consumoKgHembras" />
          </div>
        </div>

        <!-- Observaciones y Ciclo -->
        <div class="grid grid-2">
          <div class="form-field form-field--full">
            <label for="observaciones">Observaciones</label>
            <textarea id="observaciones" rows="3" formControlName="observaciones"></textarea>
          </div>

          <div class="form-field">
            <label for="ciclo">Ciclo</label>
            <div class="ux-select">
              <select id="ciclo" formControlName="ciclo">
                <option value="Normal">Normal</option>
                <option value="Reforzado">Reforzado</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Footer acciones -->
        <footer class="ux-modal__footer">
          <button type="button" class="btn btn--ghost" (click)="cancel()">Cancelar</button>
          <button type="submit" class="btn btn--primary" [disabled]="loading || form.invalid">
            {{ loading ? 'Guardando…' : 'Guardar' }}
          </button>
        </footer>
      </form>

      <!-- Loading sobre la card -->
      <div *ngIf="loading" class="loading-overlay" aria-live="polite">
        <div class="spinner"></div> Procesando…
      </div>
    </section>
  </div>
</div>
