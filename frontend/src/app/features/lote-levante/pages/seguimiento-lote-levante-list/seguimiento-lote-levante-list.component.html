<div class="ux-page" [attr.aria-busy]="loading ? 'true' : null">
  <app-sidebar class="ux-sidebar"></app-sidebar>

  <div class="ux-main">
    <header class="ux-header">
      <div class="ux-header__title">
        <h1>Seguimiento Diario de Levante</h1>

        <div class="ux-header__meta">
          <ng-template #noGranjaChip>
            <span class="chip chip--warning">
              <span class="chip__dot" aria-hidden="true"></span>
              Selecciona una granja
            </span>
          </ng-template>

          <span class="chip chip--info" *ngIf="selectedGranjaId; else noGranjaChip">
            <span class="chip chip--dot" aria-hidden="true"></span>
            Granja: {{ selectedGranjaName || selectedGranjaId }}
          </span>

          <span class="chip chip--muted" *ngIf="selectedNucleoId">
            Núcleo: {{ selectedNucleoNombre || selectedNucleoId }}
          </span>

          <span class="chip chip--muted" *ngIf="selectedGalponId">
            Galpón: {{ selectedGalponNombre }}
          </span>

          <span class="chip chip--info" *ngIf="selectedLoteId">
            <span class="chip__dot" aria-hidden="true"></span>
            Lote: {{ selectedLoteNombre }}
          </span>

          <span class="chip chip--muted" *ngIf="selectedLoteId">
            {{ calcularEdadDias(selectedLote?.fechaEncaset) }} días
          </span>

          <span class="chip chip--muted" *ngIf="selectedLoteId">
            {{ seguimientos.length || 0 }} registro(s)
          </span>
        </div>
      </div>

      <div class="ux-header__actions">
        <!-- Botón "Ver cálculos" oculto -->
        <!-- <button
          type="button"
          class="btn btn--outline"
          [disabled]="!selectedLoteId"
          [title]="!selectedLoteId ? 'Primero selecciona lote' : 'Ver cálculos del lote'"
          (click)="openCalculos()">
          Ver cálculos
        </button> -->

        <button
          type="button"
          class="btn btn--outline"
          [disabled]="!selectedLoteId"
          [title]="!selectedLoteId ? 'Primero selecciona lote' : 'Ver liquidación técnica'"
          (click)="openLiquidacion()">
          Liquidación técnica
        </button>

        <button
          type="button"
          (click)="create()"
          class="btn btn--primary"
          [disabled]="!selectedLoteId"
          [title]="!selectedLoteId ? 'Primero selecciona lote' : 'Crear nuevo registro'">
          Nuevo registro
        </button>
      </div>
    </header>

    <!-- Filtros de selección -->
    <app-filtro-select
      [selectedGranjaId]="selectedGranjaId"
      [selectedNucleoId]="selectedNucleoId"
      [selectedGalponId]="selectedGalponId"
      [selectedLoteId]="selectedLoteId"
      (granjaChange)="onGranjaChange($event)"
      (nucleoChange)="onNucleoChange($event)"
      (galponChange)="onGalponChange($event)"
      (loteChange)="onLoteChange($event)">
    </app-filtro-select>
    
    <!-- Tabs Principal: General, Indicadores y Gráfica -->
    <app-tabs-principal
      [seguimientos]="seguimientos"
      [selectedLote]="selectedLote"
      [loading]="loading"
      (create)="create()"
      (edit)="edit($event)"
      (delete)="delete($event)">
    </app-tabs-principal>
  </div>
</div>

<!-- Modal de creación/edición -->
<app-modal-create-edit
  [isOpen]="modalOpen"
  [editing]="editing"
  [lotes]="lotes"
  [selectedLoteId]="selectedLoteId"
  [loading]="loading"
  (close)="cancel()"
  (save)="onSave($event)">
</app-modal-create-edit>

<!-- ================= MODAL: CÁLCULOS ================= -->
<app-modal-calculos
  [isOpen]="calcsOpen"
  [loteId]="selectedLoteId"
  [loteNombre]="selectedLoteNombre"
  (close)="closeCalculos()">
</app-modal-calculos>

<!-- ================= MODAL: LIQUIDACIÓN TÉCNICA ================= -->
<app-modal-liquidacion
  [isOpen]="liquidacionOpen"
  [loteId]="selectedLoteId"
  [loteNombre]="selectedLoteNombre"
  (close)="closeLiquidacion()">
</app-modal-liquidacion>
