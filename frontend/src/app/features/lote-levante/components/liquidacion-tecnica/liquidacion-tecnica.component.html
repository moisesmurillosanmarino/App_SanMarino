<section class="liquidacion-container" [attr.aria-busy]="loading() ? 'true' : null">
  <!-- Header con controles -->
  <header class="liquidacion-header">
    <div class="liquidacion-title">
      <h3>Liquidaci√≥n T√©cnica</h3>
      <div class="liquidacion-meta" *ngIf="loteId">
        <span class="chip chip--info">
          <span class="chip__dot" aria-hidden="true"></span>
          {{ loteNombre || loteId }}
        </span>
      </div>
    </div>

    <div class="liquidacion-controls">
      <form [formGroup]="form" class="controls-form">
        <div class="ux-field">
          <label for="fecha-hasta">Fecha hasta</label>
          <input 
            id="fecha-hasta" 
            type="date" 
            formControlName="fechaHasta"
            class="ux-input">
        </div>

        <div class="ux-field">
          <label for="tipo-vista">Vista</label>
          <div class="ux-select">
            <select id="tipo-vista" formControlName="tipoVista">
              <option value="resumen">Resumen</option>
              <option value="completa">Completa</option>
            </select>
          </div>
        </div>

        <div class="ux-field">
          <button 
            type="button" 
            class="btn btn--outline"
            (click)="actualizar()"
            [disabled]="loading() || !loteId">
            <span *ngIf="loading()">Calculando...</span>
            <span *ngIf="!loading()">Actualizar</span>
          </button>
        </div>
      </form>
    </div>
  </header>

  <!-- Loading -->
  <div *ngIf="loading()" class="loading-overlay" aria-live="polite" role="status">
    <div class="spinner"></div>
    Calculando liquidaci√≥n t√©cnica...
  </div>

  <!-- Error -->
  <div *ngIf="error() && !loading()" class="error-state">
    <div class="error-icon" aria-hidden="true">‚ö†Ô∏è</div>
    <p>{{ error() }}</p>
    <button type="button" class="btn btn--outline" (click)="actualizar()">
      Reintentar
    </button>
  </div>

  <!-- Sin lote seleccionado -->
  <div *ngIf="!loteId && !loading()" class="empty-state">
    <div class="empty-illustration" aria-hidden="true">üìä</div>
    <p>Selecciona un lote para ver su liquidaci√≥n t√©cnica.</p>
  </div>

  <!-- Contenido principal -->
  <ng-container *ngIf="liquidacion() && !loading() && !error()">
    <!-- Informaci√≥n general del lote -->
    <section class="ux-card liquidacion-info">
      <div class="info-grid">
        <div class="info-item">
          <label>üìã Lote</label>
          <div><strong>{{ liquidacion()!.loteNombre || liquidacion()!.loteId }}</strong></div>
        </div>
        <div class="info-item">
          <label>üìÖ Fecha Encaset</label>
          <div>{{ formatDate(liquidacion()!.fechaEncaset) }}</div>
        </div>
        <div class="info-item">
          <label>üß¨ Raza</label>
          <div>{{ liquidacion()!.raza || '‚Äî' }}</div>
        </div>
        <div class="info-item">
          <label>üìä A√±o Gu√≠a</label>
          <div>{{ liquidacion()!.anoTablaGenetica || '‚Äî' }}</div>
        </div>
        <div class="info-item">
          <label>üêî Hembras Encasetadas</label>
          <div>{{ liquidacion()!.hembrasEncasetadas | number:'1.0-0' }}</div>
        </div>
        <div class="info-item">
          <label>üêì Machos Encasetados</label>
          <div>{{ liquidacion()!.machosEncasetados | number:'1.0-0' }}</div>
        </div>
        <div class="info-item">
          <label>üì¶ Total Aves</label>
          <div><strong>{{ liquidacion()!.totalAvesEncasetadas | number:'1.0-0' }}</strong></div>
        </div>
        <div class="info-item">
          <label>üìà Retiro General</label>
          <div class="valor-destacado">{{ liquidacion()!.porcentajeRetiroTotalGeneral | number:'1.2-2' }}%</div>
        </div>
      </div>
    </section>

    <!-- Tabs de navegaci√≥n -->
    <div class="liquidacion-tabs">
      <button 
        type="button"
        class="tab-btn"
        [class.active]="vistaActiva === 'resumen'"
        (click)="cambiarVista('resumen')">
        Resumen Indicadores
      </button>
      <button 
        type="button"
        class="tab-btn"
        [class.active]="vistaActiva === 'graficos'"
        (click)="cambiarVista('graficos')">
        Gr√°ficos
      </button>
      <button 
        type="button"
        class="tab-btn"
        [class.active]="vistaActiva === 'detalle'"
        [disabled]="!liquidacionCompleta()"
        (click)="cambiarVista('detalle')">
        Detalle Completo
      </button>
    </div>

    <!-- Vista Resumen -->
    <section *ngIf="vistaActiva === 'resumen'" class="ux-card liquidacion-resumen">
      <h4>Indicadores T√©cnicos</h4>
      
      <div class="ux-scroll">
        <table class="ux-table liquidacion-table">
          <thead>
            <tr>
              <th scope="col">Indicador</th>
              <th scope="col">Real</th>
              <th scope="col">Gu√≠a</th>
              <th scope="col">Diferencia</th>
              <th scope="col">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let indicador of indicadores" class="indicador-row">
              <td class="indicador-concepto">{{ indicador.concepto }}</td>
              <td class="indicador-real">
                {{ indicador.real | number:'1.2-2' }}{{ indicador.unidad }}
              </td>
              <td class="indicador-guia">
                <span *ngIf="indicador.guia !== null; else sinGuia">
                  {{ indicador.guia | number:'1.2-2' }}{{ indicador.unidad }}
                </span>
                <ng-template #sinGuia>‚Äî</ng-template>
              </td>
              <td class="indicador-diferencia">
                <span *ngIf="indicador.diferencia !== null; else sinDiferencia"
                      [class]="indicador.diferencia! > 0 ? 'diferencia-positiva' : 'diferencia-negativa'">
                  {{ indicador.diferencia! > 0 ? '+' : '' }}{{ indicador.diferencia | number:'1.2-2' }}%
                </span>
                <ng-template #sinDiferencia>‚Äî</ng-template>
              </td>
              <td class="indicador-estado">
                <span class="estado-badge" 
                      [class]="getEstadoClase(indicador.diferencia, indicador.tipo)">
                  {{ getEstadoTexto(indicador.diferencia, indicador.tipo) }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Resumen de retiros -->
      <div class="retiros-summary">
        <h5>Resumen de Retiros</h5>
        <div class="retiros-grid">
          <div class="retiro-card retiro-hembras">
            <div class="retiro-header">
              <span class="retiro-icon">üêî</span>
              <span class="retiro-titulo">Hembras</span>
            </div>
            <div class="retiro-valor">{{ liquidacion()!.porcentajeRetiroTotalHembras | number:'1.2-2' }}%</div>
            <div class="retiro-detalle">
              <small>Mort: {{ liquidacion()!.porcentajeMortalidadHembras | number:'1.2-2' }}% | 
                     Sel: {{ liquidacion()!.porcentajeSeleccionHembras | number:'1.2-2' }}% | 
                     Err: {{ liquidacion()!.porcentajeErrorSexajeHembras | number:'1.2-2' }}%</small>
            </div>
          </div>

          <div class="retiro-card retiro-machos">
            <div class="retiro-header">
              <span class="retiro-icon">üêì</span>
              <span class="retiro-titulo">Machos</span>
            </div>
            <div class="retiro-valor">{{ liquidacion()!.porcentajeRetiroTotalMachos | number:'1.2-2' }}%</div>
            <div class="retiro-detalle">
              <small>Mort: {{ liquidacion()!.porcentajeMortalidadMachos | number:'1.2-2' }}% | 
                     Sel: {{ liquidacion()!.porcentajeSeleccionMachos | number:'1.2-2' }}% | 
                     Err: {{ liquidacion()!.porcentajeErrorSexajeMachos | number:'1.2-2' }}%</small>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Vista Gr√°ficos -->
    <section *ngIf="vistaActiva === 'graficos'" class="ux-card liquidacion-graficos">
      <h4>An√°lisis Gr√°fico de Liquidaci√≥n T√©cnica</h4>
      
      <!-- Grid de gr√°ficos -->
      <div class="graficos-grid">
        <!-- Gr√°fico de barras: Indicadores Real vs Gu√≠a -->
        <div class="grafico-card">
          <div class="grafico-header">
            <h5>üìä Indicadores Real vs Gu√≠a</h5>
            <p class="grafico-descripcion">Comparaci√≥n de valores reales contra la gu√≠a gen√©tica</p>
          </div>
          <div class="grafico-container">
            <canvas
              baseChart
              [type]="'bar'"
              [data]="indicadoresChartData"
              [options]="barChartOptions"
              aria-label="Gr√°fico de barras comparando indicadores reales vs gu√≠a gen√©tica">
            </canvas>
          </div>
        </div>

        <!-- Gr√°fico de torta: Distribuci√≥n de retiros -->
        <div class="grafico-card">
          <div class="grafico-header">
            <h5>ü•ß Distribuci√≥n del Lote</h5>
            <p class="grafico-descripcion">Estado actual de las aves del lote</p>
          </div>
          <div class="grafico-container">
            <canvas
              baseChart
              [type]="'pie'"
              [data]="retirosChartData"
              [options]="pieChartOptions"
              aria-label="Gr√°fico de torta mostrando la distribuci√≥n de aves vivas, muertas y retiradas">
            </canvas>
          </div>
        </div>

        <!-- Gr√°fico de l√≠neas: Evoluci√≥n semanal -->
        <div class="grafico-card grafico-card--wide" *ngIf="liquidacionCompleta()?.detallesSeguimiento?.length">
          <div class="grafico-header">
            <h5>üìà Evoluci√≥n Semanal de Retiros</h5>
            <p class="grafico-descripcion">Tendencia de mortalidad y selecci√≥n por semanas</p>
          </div>
          <div class="grafico-container">
            <canvas
              baseChart
              [type]="'line'"
              [data]="evolucionChartData"
              [options]="lineChartOptions"
              aria-label="Gr√°fico de l√≠neas mostrando la evoluci√≥n semanal de mortalidad y selecci√≥n">
            </canvas>
          </div>
        </div>

        <!-- Gr√°fico de l√≠neas: Consumo y Peso -->
        <div class="grafico-card grafico-card--wide" *ngIf="liquidacionCompleta()?.detallesSeguimiento?.length">
          <div class="grafico-header">
            <h5>‚öñÔ∏è Consumo, Peso y Uniformidad</h5>
            <p class="grafico-descripcion">Evoluci√≥n de par√°metros productivos por semanas</p>
          </div>
          <div class="grafico-container">
            <canvas
              baseChart
              [type]="'line'"
              [data]="consumoPesoChartData"
              [options]="consumoPesoChartOptions"
              aria-label="Gr√°fico de l√≠neas mostrando la evoluci√≥n del consumo, peso y uniformidad">
            </canvas>
          </div>
        </div>
      </div>

      <!-- Mensaje si no hay datos completos -->
      <div *ngIf="!liquidacionCompleta()?.detallesSeguimiento?.length" class="graficos-info">
        <div class="info-icon" aria-hidden="true">üìä</div>
        <p><strong>Datos limitados:</strong> Para ver todos los gr√°ficos, selecciona "Vista Completa" en los controles superiores.</p>
        <p>Los gr√°ficos de evoluci√≥n semanal requieren datos de seguimiento detallado.</p>
      </div>
    </section>

    <!-- Vista Detalle -->
    <section *ngIf="vistaActiva === 'detalle' && liquidacionCompleta()" class="ux-card liquidacion-detalle">
      <h4>Liquidaci√≥n T√©cnica Completa</h4>
      
      <!-- Seguimiento por semanas -->
      <div class="detalle-section" *ngIf="liquidacionCompleta()!.detallesSeguimiento?.length">
        <h5>Seguimiento Semanal</h5>
        <div class="ux-scroll">
          <table class="ux-table detalle-table">
            <thead>
              <tr>
                <th>Semana</th>
                <th>Fecha</th>
                <th>Mort H</th>
                <th>Mort M</th>
                <th>Sel H</th>
                <th>Sel M</th>
                <th>Consumo</th>
                <th>Peso H</th>
                <th>Unif H</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let detalle of liquidacionCompleta()!.detallesSeguimiento">
                <td>{{ detalle.semana }}</td>
                <td>{{ formatDate(detalle.fechaRegistro) }}</td>
                <td>{{ detalle.mortalidadHembras || 0 }}</td>
                <td>{{ detalle.mortalidadMachos || 0 }}</td>
                <td>{{ detalle.seleccionHembras || 0 }}</td>
                <td>{{ detalle.seleccionMachos || 0 }}</td>
                <td>{{ (detalle.consumoAlimento || 0) | number:'1.2-2' }}</td>
                <td>{{ (detalle.pesoPromedioHembras || 0) | number:'1.2-2' }}</td>
                <td>{{ (detalle.uniformidadHembras || 0) | number:'1.1-1' }}%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Gu√≠a gen√©tica -->
      <div class="detalle-section" *ngIf="liquidacionCompleta()!.detallesGuiaGenetica?.length">
        <h5>Gu√≠a Gen√©tica de Referencia</h5>
        <div class="ux-scroll">
          <table class="ux-table guia-table">
            <thead>
              <tr>
                <th>Edad</th>
                <th>Raza</th>
                <th>Mort H</th>
                <th>Mort M</th>
                <th>Cons H</th>
                <th>Peso H</th>
                <th>Uniformidad</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let guia of liquidacionCompleta()!.detallesGuiaGenetica">
                <td>{{ guia.edad || '‚Äî' }}</td>
                <td>{{ guia.raza || '‚Äî' }}</td>
                <td>{{ guia.mortSemH || '‚Äî' }}</td>
                <td>{{ guia.mortSemM || '‚Äî' }}</td>
                <td>{{ guia.consAcH || '‚Äî' }}</td>
                <td>{{ guia.pesoH || '‚Äî' }}</td>
                <td>{{ guia.uniformidad || '‚Äî' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </ng-container>
</section>
