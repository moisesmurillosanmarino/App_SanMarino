<div class="dashboard-page" [attr.aria-busy]="loadingSummary ? 'true' : null">
  <app-sidebar class="dashboard-sidebar"></app-sidebar>

  <main class="dashboard-main">
    <!-- Header mejorado -->
    <header class="dashboard-header">
      <div class="header-content">
        <div class="header-title">
          <h1>üè¢ Dashboard Ejecutivo</h1>
          <p class="header-subtitle">Panel de control integral - Sistema Av√≠cola San Marino</p>
          <div class="header-meta">
            <span class="status-chip status-chip--success">
              <span class="status-dot"></span>
              Sistema Operativo
            </span>
            <span class="status-chip status-chip--info">
              <span class="status-dot"></span>
              {{ totalFarms || 0 }} Granjas Activas
            </span>
            <span class="status-chip status-chip--warning">
              <span class="status-dot"></span>
              {{ totalLotes || 0 }} Lotes Vigentes
            </span>
          </div>
        </div>
        
        <div class="header-controls">
          <div class="real-time-toggle">
            <button 
              type="button" 
              class="toggle-btn"
              [class.toggle-btn--active]="isRealTimeEnabled()"
              (click)="toggleRealTime()"
              [title]="isRealTimeEnabled() ? 'Desactivar actualizaciones autom√°ticas' : 'Activar actualizaciones autom√°ticas'">
              <span class="toggle-icon">{{ isRealTimeEnabled() ? 'üîÑ' : '‚è∏Ô∏è' }}</span>
              <span class="toggle-text">Tiempo Real</span>
            </button>
            <small class="last-update" *ngIf="isRealTimeEnabled()">
              √öltima actualizaci√≥n: {{ lastUpdated() | date:'short' }}
            </small>
          </div>
          
          <button type="button" class="refresh-btn" (click)="refreshAllData()" [disabled]="loadingSummary">
            <span class="refresh-icon">üîÑ</span>
            Actualizar Todo
          </button>
        </div>
      </div>
    </header>

    <!-- Alert de errores globales -->
    <div class="alert alert--error" *ngIf="errorSummary" role="alert" aria-live="polite">
      <div class="alert-icon">‚ö†Ô∏è</div>
      <div class="alert-content">
        <strong>Error en el sistema</strong>
        <div class="alert-text">{{ errorSummary }}</div>
      </div>
      <div class="alert-actions">
        <button type="button" class="btn btn--ghost" (click)="retrySummary()">
          Reintentar
        </button>
      </div>
    </div>

    <!-- KPIs principales mejorados -->
    <section class="kpi-grid">
      <!-- Usuarios Totales -->
      <article class="kpi-card kpi-card--primary" [class.kpi-card--loading]="loadingSummary">
        <div class="kpi-header">
          <div class="kpi-icon">üë•</div>
          <div class="kpi-info">
            <span class="kpi-label">Usuarios del Sistema</span>
            <span class="kpi-sublabel">Total registrados</span>
          </div>
        </div>
        <div class="kpi-value" *ngIf="!loadingSummary; else kpiSkeleton">
          {{ totalUsers | number }}
        </div>
        <div class="kpi-progress">
          <div class="progress-bar" [style.width.%]="100"></div>
        </div>
      </article>

      <!-- Usuarios Activos -->
      <article class="kpi-card kpi-card--success" [class.kpi-card--loading]="loadingSummary">
        <div class="kpi-header">
          <div class="kpi-icon">‚úÖ</div>
          <div class="kpi-info">
            <span class="kpi-label">Usuarios Activos</span>
            <span class="kpi-sublabel">Conectados hoy</span>
          </div>
        </div>
        <div class="kpi-value" *ngIf="!loadingSummary; else kpiSkeleton">
          {{ activeUsers | number }}
        </div>
        <div class="kpi-progress">
          <div class="progress-bar progress-bar--success" 
               [style.width.%]="totalUsers ? (activeUsers * 100) / totalUsers : 0"></div>
        </div>
        <div class="kpi-percentage" *ngIf="!loadingSummary">
          {{ totalUsers ? ((activeUsers * 100) / totalUsers | number:'1.0-1') : 0 }}% activos
        </div>
      </article>

      <!-- Total de Aves -->
      <article class="kpi-card kpi-card--warning" [class.kpi-card--loading]="loadingSummary">
        <div class="kpi-header">
          <div class="kpi-icon">üêî</div>
          <div class="kpi-info">
            <span class="kpi-label">Aves Activas</span>
            <span class="kpi-sublabel">En todos los lotes</span>
          </div>
        </div>
        <div class="kpi-value" *ngIf="!loadingSummary; else kpiSkeleton">
          {{ totalAvesActivas() | number }}
        </div>
        <div class="kpi-progress">
          <div class="progress-bar progress-bar--warning" [style.width.%]="100"></div>
        </div>
      </article>

      <!-- Edad Promedio -->
      <article class="kpi-card kpi-card--info" [class.kpi-card--loading]="loadingSummary">
        <div class="kpi-header">
          <div class="kpi-icon">üìÖ</div>
          <div class="kpi-info">
            <span class="kpi-label">Edad Promedio</span>
            <span class="kpi-sublabel">D√≠as de los lotes</span>
          </div>
        </div>
        <div class="kpi-value" *ngIf="!loadingSummary; else kpiSkeleton">
          {{ promedioEdadLotes() }}
          <span class="kpi-unit">d√≠as</span>
        </div>
        <div class="kpi-progress">
          <div class="progress-bar progress-bar--info" [style.width.%]="75"></div>
        </div>
      </article>
    </section>

    <!-- Gr√°ficas principales -->
    <section class="charts-grid">
      <!-- Registros Diarios -->
      <article class="chart-card" appLazyObserve (visible)="onDailyVisible()">
        <header class="chart-header">
          <div class="chart-title">
            <h3>üìä Registros Diarios</h3>
            <p class="chart-subtitle">Actividad de registro en los √∫ltimos 7 d√≠as</p>
          </div>
          <div class="chart-controls">
            <span class="loading-indicator" [class.loading-indicator--active]="loadingDaily"></span>
          </div>
        </header>

        <div class="alert alert--error" *ngIf="errorDaily" role="alert">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div class="alert-content">
            <strong>Error al cargar registros diarios</strong>
            <div class="alert-text">{{ errorDaily }}</div>
          </div>
          <div class="alert-actions">
            <button type="button" class="btn btn--ghost" (click)="retryDaily()">Reintentar</button>
          </div>
        </div>

        <div class="chart-container" *ngIf="!loadingDaily && !errorDaily && dailyLogs?.length; else chartSkeleton">
          <canvas baseChart
                  [data]="dailyRegistersChart"
                  [type]="lineChartType"
                  [options]="chartOptions">
          </canvas>
        </div>
      </article>

      <!-- Producci√≥n por Granja -->
      <article class="chart-card" appLazyObserve (visible)="onProductionVisible()">
        <header class="chart-header">
          <div class="chart-title">
            <h3>üè≠ Producci√≥n por Granja</h3>
            <p class="chart-subtitle">Rendimiento relativo de cada granja</p>
          </div>
          <div class="chart-badge">
            Promedio: {{ eficienciaPromedio() }}%
          </div>
        </header>

        <div class="alert alert--error" *ngIf="errorProduction" role="alert">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div class="alert-content">
            <strong>Error al cargar producci√≥n</strong>
            <div class="alert-text">{{ errorProduction }}</div>
          </div>
          <div class="alert-actions">
            <button type="button" class="btn btn--ghost" (click)="retryProduction()">Reintentar</button>
          </div>
        </div>

        <div class="chart-container" *ngIf="!loadingProduction && !errorProduction && farms?.length; else chartSkeleton">
          <canvas baseChart
                  [data]="productionChart"
                  [type]="barChartType"
                  [options]="chartOptions">
          </canvas>
        </div>
      </article>

      <!-- Mortalidad -->
      <article class="chart-card" appLazyObserve (visible)="onMortalityVisible()">
        <header class="chart-header">
          <div class="chart-title">
            <h3>üíÄ An√°lisis de Mortalidad</h3>
            <p class="chart-subtitle">Distribuci√≥n de mortalidad por fecha</p>
          </div>
        </header>

        <div class="alert alert--error" *ngIf="errorMortality" role="alert">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div class="alert-content">
            <strong>Error al cargar mortalidad</strong>
            <div class="alert-text">{{ errorMortality }}</div>
          </div>
          <div class="alert-actions">
            <button type="button" class="btn btn--ghost" (click)="retryMortality()">Reintentar</button>
          </div>
        </div>

        <div class="chart-container" *ngIf="!loadingMortality && !errorMortality && mortalities?.length; else chartSkeleton">
          <canvas baseChart
                  [data]="mortalityChart"
                  [type]="doughnutChartType"
                  [options]="doughnutOptions">
          </canvas>
        </div>
      </article>

      <!-- Distribuci√≥n de Lotes -->
      <article class="chart-card">
        <header class="chart-header">
          <div class="chart-title">
            <h3>üóÇÔ∏è Distribuci√≥n de Lotes</h3>
            <p class="chart-subtitle">Lotes por granja</p>
          </div>
        </header>

        <div class="chart-container" *ngIf="!loadingSummary && totalLotes > 0; else chartSkeleton">
          <canvas baseChart
                  [data]="farmDistributionChart"
                  [type]="pieChartType"
                  [options]="doughnutOptions">
          </canvas>
        </div>
      </article>
    </section>

    <!-- Actividades Recientes -->
    <section class="activity-section">
      <article class="activity-card" appLazyObserve (visible)="onActivitiesVisible()">
        <header class="activity-header">
          <div class="activity-title">
            <h3>üîÑ Actividades Recientes</h3>
            <p class="activity-subtitle">√öltimas operaciones del sistema</p>
          </div>
          <div class="activity-controls">
            <span class="loading-indicator" [class.loading-indicator--active]="loadingActivities"></span>
            <span class="activity-count">{{ activities.length || 0 }} registros</span>
          </div>
        </header>

        <div class="alert alert--error" *ngIf="errorActivities" role="alert">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div class="alert-content">
            <strong>Error al cargar actividades</strong>
            <div class="alert-text">{{ errorActivities }}</div>
          </div>
          <div class="alert-actions">
            <button type="button" class="btn btn--ghost" (click)="retryActivities()">Reintentar</button>
          </div>
        </div>

        <div class="activity-list" *ngIf="!loadingActivities && !errorActivities && activities?.length; else activitySkeleton">
          <div class="activity-item" *ngFor="let activity of activities; trackBy: trackByActivity">
            <div class="activity-time">{{ activity.time }}</div>
            <div class="activity-description">{{ activity.description }}</div>
            <div class="activity-indicator"></div>
          </div>
        </div>
      </article>
    </section>
  </main>
</div>

<!-- Skeletons mejorados -->
<ng-template #kpiSkeleton>
  <div class="skeleton skeleton--kpi"></div>
</ng-template>

<ng-template #chartSkeleton>
  <div class="skeleton skeleton--chart"></div>
</ng-template>

<ng-template #activitySkeleton>
  <div class="skeleton-list">
    <div class="skeleton skeleton--activity" *ngFor="let item of [1,2,3,4,5]"></div>
  </div>
</ng-template>