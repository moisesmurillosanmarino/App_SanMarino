<!-- N√∫cleos: lista + modal (embebible/aut√≥nomo) -->
<section class="ux-page" [attr.aria-busy]="loading ? 'true' : null">
  <!-- Header solo en modo aut√≥nomo (l√≠nea amarilla y bot√≥n a la derecha) -->
  <header class="ux-header" *ngIf="!embedded">
    <button class="btn-primary" (click)="openModal()">
      <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
      <span>Nuevo N√∫cleo</span>
    </button>
  </header>

  <!-- ================= Filtros ================= -->
  <div class="ux-card" role="group" aria-label="Filtros de b√∫squeda y selecci√≥n" style="padding: .85rem; margin-bottom: 1rem;">
    <form (submit)="$event.preventDefault()">
      <div style="display:grid; grid-template-columns: 260px 260px 1fr auto; gap:.75rem; align-items:end;">
        <!-- Compa√±√≠a -->
        <div>
          <label for="f-company" class="ux-label">Compa√±√≠a</label>
          <select
            id="f-company"
            class="ux-select"
            [ngModel]="selectedCompanyId"
            (ngModelChange)="onCompanyChange($event)">
            <option [ngValue]="null">Todas las compa√±√≠as</option>
            <option *ngFor="let c of companies" [ngValue]="c.id">{{ c.name }}</option>
          </select>
        </div>

        <!-- Granja (depende de compa√±√≠a) -->
        <div>
          <label for="f-farm" class="ux-label">Granja</label>
          <select
            id="f-farm"
            class="ux-select"
            [ngModel]="selectedFarmId"
            (ngModelChange)="selectedFarmId = $event; recompute()">
            <option [ngValue]="null">Todas las granjas</option>
            <option *ngFor="let f of farmsFiltered" [ngValue]="f.id">{{ f.name }}</option>
          </select>
        </div>

        <!-- B√∫squeda -->
        <div class="ux-search">
          <label for="filtro" class="ux-label sr-only">Buscar n√∫cleo</label>
          <span class="ux-search__icon" aria-hidden="true">
            <fa-icon [icon]="['fas','magnifying-glass']"></fa-icon>
          </span>
          <input
            id="filtro"
            type="search"
            class="ux-input"
            placeholder="Por nombre, ID o granja‚Ä¶"
            [ngModel]="filtro"
            (ngModelChange)="filtro = $event; recompute()"
            aria-label="Campo de b√∫squeda de n√∫cleos" />
        </div>

        <!-- Acciones -->
        <div style="display:flex; align-items:center; justify-content:flex-end;">
          <button type="button" class="btn-ghost" (click)="resetFilters()">Limpiar</button>
        </div>
      </div>
    </form>
  </div>

  <!-- ================= Tabla ================= -->
  <div class="ux-card" role="region" aria-label="Listado de n√∫cleos" style="position:relative;">
    <div class="ux-scroll">
      <table class="ux-table">
        <caption class="sr-only">Listado de n√∫cleos</caption>
        <thead>
          <tr>
            <th class="col-id">ID N√∫cleo</th>
            <th class="col-nombre">Nombre N√∫cleo</th>
            <th class="col-granja">Granja</th>
            <th class="col-company">Compa√±√≠a</th>
            <th class="col-actions text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Estado: cargando -->
          <tr *ngIf="loading" aria-live="polite">
            <td colspan="5" class="empty-state">
              <div class="spinner" aria-hidden="true"></div>
              Cargando n√∫cleos‚Ä¶
            </td>
          </tr>

          <!-- Estado: vac√≠o -->
          <tr *ngIf="!loading && viewNucleos?.length === 0">
            <td colspan="5" class="empty-state">
              <div class="empty-illustration" aria-hidden="true">üóÇÔ∏è</div>
              <p>No hay n√∫cleos para mostrar.</p>
              <button class="btn-secondary" (click)="openModal()">
                <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
                <span>Crear el primero</span>
              </button>
            </td>
          </tr>

          <!-- Filas -->
          <tr *ngFor="let n of viewNucleos; trackBy: trackByNucleo" class="ux-row">
            <td class="col-id">{{ n.nucleoId }}</td>
            <td class="col-nombre"><span class="text-ellipsis">{{ n.nucleoNombre }}</span></td>
            <td class="col-granja"><span class="text-ellipsis">{{ getFarmName(n.granjaId) }}</span></td>
            <td class="col-company"><span class="text-ellipsis">{{ getCompanyName(n.granjaId) }}</span></td>
            <td class="col-actions">
              <div class="actions">
                <button class="icon-btn" title="Editar" aria-label="Editar n√∫cleo" (click)="openModal(n)">
                  <fa-icon [icon]="faPen" aria-hidden="true"></fa-icon>
                </button>
                <button class="icon-btn danger" title="Eliminar" aria-label="Eliminar n√∫cleo" (click)="delete(n)">
                  <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Overlay de carga (sobre la card) -->
    <div *ngIf="loading" class="loading-overlay" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      Cargando‚Ä¶
    </div>
  </div>

  <!-- ================= Modal: Crear / Editar ================= -->
  <div
    *ngIf="modalOpen"
    class="ux-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="nucleo-title">
    <div class="ux-modal__panel">
      <div class="ux-modal__header">
        <h2 id="nucleo-title" class="ux-title">{{ editing ? 'Editar N√∫cleo' : 'Nuevo N√∫cleo' }}</h2>
        <button class="btn-muted" type="button" (click)="closeModal()" aria-label="Cerrar">Cerrar</button>
      </div>

      <!-- Bloque meta (opcional cuando edita) -->
      <div class="ux-meta" *ngIf="editing">
            <div class="ux-meta__item"><strong>ID actual:</strong> {{ editing!.nucleoId }}</div>
            <div class="ux-meta__item"><strong>Granja actual:</strong> {{ getFarmName(editing!.granjaId) }}</div>
      </div>

      <form [formGroup]="form" (ngSubmit)="save()" style="margin-top:.75rem;">
        <!-- ID (se autogenera) -->
        <input type="hidden" formControlName="nucleoId" />

        <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.75rem;">
          <!-- Granja -->
          <div>
            <label class="ux-label" for="field-granja">Granja <span class="req">*</span></label>
            <select id="field-granja" class="ux-select" formControlName="granjaId">
              <option [ngValue]="null" disabled>Seleccione‚Ä¶</option>
              <option *ngFor="let f of farmsFiltered" [ngValue]="f.id">{{ f.name }}</option>
            </select>
          </div>

          <!-- Nombre N√∫cleo -->
          <div>
            <label class="ux-label" for="field-nombre">Nombre N√∫cleo <span class="req">*</span></label>
            <input id="field-nombre" class="ux-input" type="text" formControlName="nucleoNombre" />
          </div>
        </div>

        <!-- Mostrar ID asignado (solo informativo) -->
        <div style="margin-top:.5rem;" *ngIf="form.get('nucleoId')?.value">
          <small class="text-center" style="display:block; opacity:.7;">
            ID asignado: <strong>{{ form.get('nucleoId')?.value }}</strong>
          </small>
        </div>

        <div class="ux-actions">
          <button type="button" class="btn-ghost" (click)="closeModal()">Cancelar</button>
          <button type="submit" class="btn-primary" [disabled]="form.invalid || loading">
            {{ editing ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
  <!-- /Modal -->
</section>
