<div class="flex h-screen">
  <app-sidebar class="w-64"></app-sidebar>

  <div class="main-content" [attr.aria-busy]="loading ? 'true' : null">
    <!-- Header -->
    <div class="header">
      <div class="header__title">
        <h1>Gesti√≥n de N√∫cleos</h1>
      </div>
      <button class="btn-primary" (click)="openModal()">
        <fa-icon [icon]="faPlus" class="mr-2" aria-hidden="true"></fa-icon>
        Nuevo N√∫cleo
      </button>
    </div>

    <!-- Filtros (Compa√±√≠a / Granja / Texto) -->
    <div class="ux-card p-4 mb-4">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
        <!-- Compa√±√≠a -->
        <div class="lg:col-span-4">
          <label for="f-company" class="ux-label">Compa√±√≠a</label>
          <select
            id="f-company"
            class="ux-select"
            [(ngModel)]="selectedCompanyId"
            (ngModelChange)="onCompanyChange($event)"
          >
            <option [ngValue]="null">Todas las compa√±√≠as</option>
            <option *ngFor="let c of companies" [ngValue]="c.id">{{ c.name }}</option>
          </select>
        </div>

        <!-- Granja (dependiente de compa√±√≠a) -->
        <div class="lg:col-span-4">
          <label for="f-farm" class="ux-label">Granja</label>
          <select
            id="f-farm"
            class="ux-select"
            [(ngModel)]="selectedFarmId"
            (ngModelChange)="recompute()"
          >
            <option [ngValue]="null">Todas las granjas</option>
            <option *ngFor="let f of farmsFiltered" [ngValue]="f.id">{{ f.name }}</option>
          </select>
        </div>

        <!-- B√∫squeda de texto -->
        <div class="lg:col-span-3">
          <label for="filtro" class="ux-label">Buscar n√∫cleo</label>
          <div class="filter__inputwrap">
            <input
              id="filtro"
              type="text"
              [(ngModel)]="filtro"
              (ngModelChange)="recompute()"
              placeholder="Buscar por nombre, ID o granja‚Ä¶"
              class="ux-input"
            />
            <span class="filter__icon" aria-hidden="true">
              <fa-icon [icon]="['fas','search']"></fa-icon>
            </span>
          </div>
        </div>

        <!-- Limpiar -->
        <div class="lg:col-span-1">
          <button class="btn-ghost w-full" (click)="resetFilters()">Limpiar</button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="ux-card">
      <div class="ux-scroll">
        <table class="ux-table">
          <caption class="sr-only">Listado de n√∫cleos</caption>

          <thead>
            <tr>
              <th scope="col">ID N√∫cleo</th>
              <th scope="col">Nombre N√∫cleo</th>
              <th scope="col">Granja</th>
              <th scope="col">Compa√±√≠a</th>
              <th scope="col" class="text-center">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <!-- Estado: cargando -->
            <tr *ngIf="loading" aria-live="polite">
              <td colspan="5" class="empty-state">
                <div class="spinner"></div>
                Cargando n√∫cleos‚Ä¶
              </td>
            </tr>

            <!-- Estado: vac√≠o -->
            <tr *ngIf="!loading && viewNucleos.length === 0">
              <td colspan="5" class="empty-state">
                <div class="empty-illustration">üóÇÔ∏è</div>
                <p>No hay n√∫cleos para mostrar.</p>
                <button class="btn-secondary mt-2" (click)="openModal()">
                  <fa-icon [icon]="faPlus" class="mr-2" aria-hidden="true"></fa-icon>
                  Crear el primero
                </button>
              </td>
            </tr>

            <!-- Filas -->
            <tr *ngFor="let n of viewNucleos" class="ux-row">
              <td>{{ n.nucleoId }}</td>
              <td>{{ n.nucleoNombre }}</td>
              <td>{{ getFarmName(n.granjaId) }}</td>
              <td>{{ getCompanyName(n.granjaId) }}</td>
              <td class="text-center">
                <div class="actions">
                  <button
                    class="icon-btn"
                    title="Editar"
                    aria-label="Editar n√∫cleo"
                    (click)="openModal(n)"
                  >
                    <fa-icon [icon]="faPen" aria-hidden="true"></fa-icon>
                  </button>

                  <button
                    class="icon-btn danger"
                    title="Eliminar"
                    aria-label="Eliminar n√∫cleo"
                    (click)="delete(n)"
                  >
                    <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Overlay de carga (sobre la card) -->
      <div *ngIf="loading" class="loading-overlay" aria-live="polite">
        <div class="spinner"></div>
        Cargando‚Ä¶
      </div>
    </div>

    <!-- Modal -->
    <div *ngIf="modalOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="nucleo-title">
      <div class="ux-modal__panel">
        <div class="ux-modal__header">
          <h2 id="nucleo-title">{{ editing ? 'Editar N√∫cleo' : 'Nuevo N√∫cleo' }}</h2>
          <button class="ux-modal__close" (click)="modalOpen = false" aria-label="Cerrar">√ó</button>
        </div>

        <form [formGroup]="form" (ngSubmit)="save()" class="ux-form" novalidate>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="ux-label">ID N√∫cleo <span class="req">*</span></label>
              <input class="ux-input" formControlName="nucleoId" [readonly]="!!editing" />
            </div>

            <div>
              <label class="ux-label">Granja <span class="req">*</span></label>
              <select class="ux-select" formControlName="granjaId">
                <option value="" disabled>Seleccione‚Ä¶</option>
                <option *ngFor="let f of farms" [value]="f.id">{{ f.name }}</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="ux-label">Nombre N√∫cleo <span class="req">*</span></label>
              <input class="ux-input" formControlName="nucleoNombre" />
            </div>
          </div>

          <div class="ux-modal__actions">
            <button type="button" class="btn-ghost" (click)="modalOpen = false">Cancelar</button>
            <button type="submit" class="btn-primary" [disabled]="form.invalid">
              {{ editing ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
