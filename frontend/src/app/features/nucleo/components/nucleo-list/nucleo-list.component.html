<!-- N√∫cleos: lista + modal (embebible/aut√≥nomo) -->
<div class="flex" [class.h-screen]="!embedded" [attr.aria-busy]="loading ? 'true' : null">


  <!-- Contenido -->
  <div class="flex-1 p-6 overflow-auto ux-page">
    <!-- Header solo en modo aut√≥nomo -->
    <div class="ux-header" *ngIf="!embedded">
      <button class="btn-primary" (click)="openModal()">
        <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
        Nuevo N√∫cleo
      </button>
    </div>

    <!-- ================= Filtros ================= -->
    <div class="ux-card filters mb-4" role="group" aria-label="Filtros de b√∫squeda y selecci√≥n">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
        <!-- Compa√±√≠a -->
        <div class="lg:col-span-4">
          <label for="f-company" class="ux-label">Compa√±√≠a</label>
          <select
            id="f-company"
            class="ux-select"
            [(ngModel)]="selectedCompanyId"
            (ngModelChange)="onCompanyChange($event)">
            <option [ngValue]="null">Todas las compa√±√≠as</option>
            <option *ngFor="let c of companies" [ngValue]="c.id">{{ c.name }}</option>
          </select>
        </div>

        <!-- Granja (depende de compa√±√≠a) -->
        <div class="lg:col-span-4">
          <label for="f-farm" class="ux-label">Granja</label>
          <select
            id="f-farm"
            class="ux-select"
            [(ngModel)]="selectedFarmId"
            (ngModelChange)="recompute()">
            <option [ngValue]="null">Todas las granjas</option>
            <option *ngFor="let f of farmsFiltered" [ngValue]="f.id">{{ f.name }}</option>
          </select>
        </div>

        <!-- B√∫squeda -->
        <div class="lg:col-span-3">
          <label for="filtro" class="ux-label">Buscar n√∫cleo</label>
          <div class="ux-search">
            <fa-icon [icon]="['fas','magnifying-glass']" class="ux-search__icon" aria-hidden="true"></fa-icon>
            <input
              id="filtro"
              type="text"
              class="ux-input"
              placeholder="Por nombre, ID o granja‚Ä¶"
              [(ngModel)]="filtro"
              (ngModelChange)="recompute()"
              aria-label="Campo de b√∫squeda de n√∫cleos" />
          </div>
        </div>

        <!-- Acciones -->
        <div class="lg:col-span-1 flex items-end">
          <button class="btn-ghost w-full" (click)="resetFilters()">Limpiar</button>
        </div>
      </div>
    </div>

    <!-- ================= Tabla ================= -->
    <div class="ux-card" role="region" aria-label="Listado de n√∫cleos">
      <div class="ux-scroll">
        <table class="ux-table">
          <caption class="sr-only">Listado de n√∫cleos</caption>
          <thead>
            <tr>
              <th class="col-id">ID N√∫cleo</th>
              <th class="col-nombre">Nombre N√∫cleo</th>
              <th class="col-granja">Granja</th>
              <th class="col-company">Compa√±√≠a</th>
              <th class="col-actions text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Estado: cargando -->
            <tr *ngIf="loading" aria-live="polite">
              <td colspan="5" class="empty-state">
                <div class="spinner"></div>
                Cargando n√∫cleos‚Ä¶
              </td>
            </tr>

            <!-- Estado: vac√≠o -->
            <tr *ngIf="!loading && viewNucleos?.length === 0">
              <td colspan="5" class="empty-state">
                <div class="empty-illustration">üóÇÔ∏è</div>
                <p>No hay n√∫cleos para mostrar.</p>
                <button class="btn-secondary mt-2" (click)="openModal()">
                  <fa-icon [icon]="faPlus" class="mr-2" aria-hidden="true"></fa-icon>
                  Crear el primero
                </button>
              </td>
            </tr>

            <!-- Filas -->
            <tr *ngFor="let n of viewNucleos; trackBy: trackByNucleo" class="ux-row">
              <td class="col-id">{{ n.nucleoId }}</td>
              <td class="col-nombre"><span class="truncate">{{ n.nucleoNombre }}</span></td>
              <td class="col-granja"><span class="truncate">{{ getFarmName(n.granjaId) }}</span></td>
              <td class="col-company"><span class="truncate">{{ getCompanyName(n.granjaId) }}</span></td>
              <td class="col-actions">
                <div class="actions">
                  <button class="icon-btn" title="Editar" aria-label="Editar n√∫cleo" (click)="openModal(n)">
                    <fa-icon [icon]="faPen" aria-hidden="true"></fa-icon>
                  </button>
                  <button class="icon-btn danger" title="Eliminar" aria-label="Eliminar n√∫cleo" (click)="delete(n)">
                    <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Overlay de carga -->
      <div *ngIf="loading" class="loading-overlay" aria-live="polite">
        <div class="spinner"></div>
        Cargando‚Ä¶
      </div>
    </div>

    <!-- ================= Modal: Crear / Editar ================= -->
    <div
      *ngIf="modalOpen"
      class="ux-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="nucleo-title">
      <div class="ux-modal__panel" style="max-width: 700px;">
        <div class="ux-modal__header">
          <h2 id="nucleo-title">{{ editing ? 'Editar N√∫cleo' : 'Nuevo N√∫cleo' }}</h2>
          <button class="ux-modal__close" (click)="modalOpen = false" aria-label="Cerrar">√ó</button>
        </div>

        <form [formGroup]="form" (ngSubmit)="save()" class="ux-form" novalidate>
          <!-- ID oculto (se autogenera) -->
          <input type="hidden" formControlName="nucleoId" />

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Granja -->
            <div>
              <label class="ux-label">Granja <span class="req">*</span></label>
              <select class="ux-select" formControlName="granjaId">
                <option value="" disabled>Seleccione‚Ä¶</option>
                <option *ngFor="let f of farms" [value]="f.id">{{ f.name }}</option>
              </select>
            </div>

            <!-- Nombre N√∫cleo -->
            <div class="md:col-span-2">
              <label class="ux-label">Nombre N√∫cleo <span class="req">*</span></label>
              <input class="ux-input" formControlName="nucleoNombre" />
            </div>

            <!-- (Opcional) Mostrar ID asignado sin permitir edici√≥n -->
            <div class="md:col-span-2" *ngIf="form.get('nucleoId')?.value">
              <small class="text-center block" style="opacity:.7">
                ID asignado: <strong>{{ form.get('nucleoId')?.value }}</strong>
              </small>
            </div>
          </div>

          <div class="ux-modal__actions">
            <button type="button" class="btn-ghost" (click)="modalOpen = false">Cancelar</button>
            <button type="submit" class="btn-primary" [disabled]="form.invalid || loading">
              {{ editing ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- /Modal -->
  </div>
</div>
