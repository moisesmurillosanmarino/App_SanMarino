<div *ngIf="isOpen" class="modal-overlay" (click)="onClose()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üìä C√°lculos Avanzados de Producci√≥n</h2>
      <button type="button" class="close-btn" (click)="onClose()" aria-label="Cerrar">
        ‚úï
      </button>
    </div>

    <div class="modal-body">
      <!-- Informaci√≥n del lote -->
      <div class="lote-info">
        <h3>{{ loteNombre || 'Lote ' + loteId }}</h3>
        <p>An√°lisis detallado de m√©tricas de producci√≥n</p>
      </div>

      <!-- Filtros -->
      <div class="filtros-section">
        <h4>üîç Filtros de An√°lisis</h4>
        <div class="filtros-grid">
          <div class="filtro-item">
            <label for="desde">Desde:</label>
            <input 
              id="desde"
              type="date" 
              [(ngModel)]="calcsDesde"
              (ngModelChange)="reloadCalculos()">
          </div>
          
          <div class="filtro-item">
            <label for="hasta">Hasta:</label>
            <input 
              id="hasta"
              type="date" 
              [(ngModel)]="calcsHasta"
              (ngModelChange)="reloadCalculos()">
          </div>
          
          <div class="filtro-item">
            <button 
              type="button" 
              class="btn btn--outline"
              (click)="onLimpiarFiltros()">
              üóëÔ∏è Limpiar Filtros
            </button>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div class="resultados-section" *ngIf="calcsResp">
        <h4>üìà Resultados del An√°lisis</h4>
        
        <div class="resumen-metricas">
          <div class="metrica-item">
            <span class="metrica-label">Per√≠odo:</span>
            <span class="metrica-value">
              {{ calcsResp.desde ? formatDMY(calcsResp.desde) : 'Inicio' }} - 
              {{ calcsResp.hasta ? formatDMY(calcsResp.hasta) : 'Actual' }}
            </span>
          </div>
          
          <div class="metrica-item">
            <span class="metrica-label">Total registros:</span>
            <span class="metrica-value">{{ calcsResp.total }}</span>
          </div>
        </div>

        <!-- Tabla de resultados -->
        <div class="tabla-resultados" *ngIf="calcsResp.items.length > 0">
          <table class="data-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Edad (d√≠as)</th>
                <th>Mort. H</th>
                <th>Mort. M</th>
                <th>Mort. Total</th>
                <th>Mort. %</th>
                <th>Sel H</th>
                <th>ConsKg H</th>
                <th>ConsKg M</th>
                <th>Huevo Tot</th>
                <th>Huevo Inc</th>
                <th>Eficiencia</th>
                <th>Peso Huevo</th>
                <th>Etapa</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of calcsResp.items">
                <td>{{ formatDMY(item.fecha) }}</td>
                <td>{{ item.edadDias || 'N/A' }}</td>
                <td>{{ item.mortalidadH }}</td>
                <td>{{ item.mortalidadM }}</td>
                <td>{{ item.mortalidadTotal }}</td>
                <td>
                  <span class="badge" [class]="'badge--' + getMortalidadColor(item.mortalidadPorcentaje)">
                    {{ item.mortalidadPorcentaje | number:'1.1-1' }}%
                  </span>
                </td>
                <td>{{ item.selH }}</td>
                <td>{{ item.consKgH | number:'1.2-2' }}</td>
                <td>{{ item.consKgM | number:'1.2-2' }}</td>
                <td>{{ item.huevoTot }}</td>
                <td>{{ item.huevoInc }}</td>
                <td>
                  <span class="badge" [class]="'badge--' + getEficienciaColor(item.eficiencia)">
                    {{ item.eficiencia | number:'1.1-1' }}%
                  </span>
                </td>
                <td>{{ item.pesoHuevo | number:'1.1-1' }}g</td>
                <td>{{ item.etapa }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="calcsResp.items.length === 0" class="empty-results">
          <div class="empty-icon">üìä</div>
          <p>No hay datos para el per√≠odo seleccionado.</p>
        </div>
      </div>

      <!-- Estado de carga -->
      <div *ngIf="calcsLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Calculando m√©tricas...</p>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn--primary" (click)="onClose()">
        Cerrar
      </button>
    </div>
  </div>
</div>
