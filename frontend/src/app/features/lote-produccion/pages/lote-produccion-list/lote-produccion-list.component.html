<div class="ux-page" [attr.aria-busy]="loading ? 'true' : null">
  <app-sidebar class="ux-sidebar"></app-sidebar>

  <div class="ux-main">
    <header class="ux-header">
      <div class="ux-header__title">
        <h1>Seguimiento Diario de Producción</h1>

        <div class="ux-header__meta">
          <ng-template #noGranjaChip>
            <span class="chip chip--warning">
              <span class="chip__dot" aria-hidden="true"></span>
              Selecciona una granja
            </span>
          </ng-template>

          <span class="chip chip--info" *ngIf="selectedGranjaId; else noGranjaChip">
            <span class="chip chip--dot" aria-hidden="true"></span>
            Granja: {{ selectedGranjaName || selectedGranjaId }}
          </span>

          <span class="chip chip--muted" *ngIf="selectedNucleoId">
            Núcleo: {{ selectedNucleoNombre || selectedNucleoId }}
          </span>

          <span class="chip chip--muted" *ngIf="selectedGalponId">
            Galpón: {{ selectedGalponNombre }}
          </span>

          <span class="chip chip--info" *ngIf="selectedLoteId">
            <span class="chip__dot" aria-hidden="true"></span>
            Lote: {{ selectedLoteNombre }}
          </span>

          <span class="chip chip--muted" *ngIf="selectedLoteId && produccionLote">
            {{ calcularEdadDias(produccionLote.fechaInicio) }} días
          </span>

          <span class="chip chip--muted" *ngIf="selectedLoteId">
            {{ seguimientos.length || 0 }} registro(s)
          </span>
        </div>
      </div>

      <div class="ux-header__actions">
        <button
          type="button"
          class="btn btn--outline"
          [disabled]="!selectedLoteId"
          [title]="!selectedLoteId ? 'Primero selecciona lote' : 'Ver análisis del lote'"
          (click)="openAnalisis()">
          Ver análisis
        </button>

        <button
          type="button"
          (click)="create()"
          class="btn btn--primary"
          [disabled]="!selectedLoteId"
          [title]="!selectedLoteId ? 'Primero selecciona lote' : 'Crear nuevo registro'">
          Nuevo registro
        </button>
      </div>
    </header>

    <!-- Filtros de selección -->
    <app-filtro-select
      [selectedGranjaId]="selectedGranjaId"
      [selectedNucleoId]="selectedNucleoId"
      [selectedGalponId]="selectedGalponId"
      [selectedLoteId]="selectedLoteId"
      (granjaChange)="onGranjaChange($event)"
      (nucleoChange)="onNucleoChange($event)"
      (galponChange)="onGalponChange($event)"
      (loteChange)="onLoteChange($event)">
    </app-filtro-select>
    
    <!-- Tabs Principal: General, Indicadores y Gráfica -->
    <app-tabs-principal
      [seguimientos]="seguimientos"
      [selectedLote]="null"
      [loading]="loading"
      (create)="openDailyTrackingModal()"
      (edit)="editDailyTracking($event)"
      (delete)="deleteDailyTracking($event)">
    </app-tabs-principal>
  </div>
</div>

<!-- Modal de registro inicial -->
<app-modal-registro-inicial
  [isOpen]="modalRegistroInicialOpen"
  [loteId]="selectedLoteId"
  [loading]="loading"
  (close)="cancelRegistroInicial()"
  (save)="onSaveRegistroInicial($event)">
</app-modal-registro-inicial>

<!-- Modal de seguimiento diario -->
<app-modal-seguimiento-diario
  [isOpen]="modalSeguimientoDiarioOpen"
  [produccionLoteId]="currentProduccionLoteId"
  [editingSeguimiento]="editingSeguimiento"
  [loading]="loading"
  (close)="cancelSeguimientoDiario()"
  (save)="onSaveSeguimientoDiario($event)">
</app-modal-seguimiento-diario>

<!-- Modal de análisis -->
<app-modal-analisis
  [isOpen]="analisisOpen"
  [seguimientos]="seguimientos"
  (close)="closeAnalisis()"
  (export)="exportarAnalisis()">
</app-modal-analisis>