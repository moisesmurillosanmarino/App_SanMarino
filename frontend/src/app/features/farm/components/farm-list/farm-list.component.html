<!-- src/app/features/farm/components/farm-list/farm-list.component.html -->
<div class="flex h-screen">
  <app-sidebar class="w-64"></app-sidebar>

  <!-- Contenido -->
  <div class="flex-1 p-6 overflow-auto ux-page" [attr.aria-busy]="loading ? 'true' : null">

    <!-- Tabs locales (sin router) -->
    <div class="ux-tabs mb-4" role="tablist" aria-label="MÃ³dulos relacionados">
      <button
        id="tab-granjas"
        type="button"
        class="ux-tab"
        role="tab"
        [class.active]="activeTab === 'granjas'"
        (click)="activeTab = 'granjas'"
        [attr.aria-selected]="activeTab === 'granjas' ? 'true' : 'false'"
        [attr.tabindex]="activeTab === 'granjas' ? '0' : '-1'"
        aria-controls="panel-granjas"
      >
        Granjas
      </button>

      <button
        id="tab-nucleos"
        type="button"
        class="ux-tab"
        role="tab"
        [class.active]="activeTab === 'nucleos'"
        (click)="activeTab = 'nucleos'"
        [attr.aria-selected]="activeTab === 'nucleos' ? 'true' : 'false'"
        [attr.tabindex]="activeTab === 'nucleos' ? '0' : '-1'"
        aria-controls="panel-nucleos"
      >
        NÃºcleos
      </button>

      <button
        id="tab-galpones"
        type="button"
        class="ux-tab"
        role="tab"
        [class.active]="activeTab === 'galpones'"
        (click)="activeTab = 'galpones'"
        [attr.aria-selected]="activeTab === 'galpones' ? 'true' : 'false'"
        [attr.tabindex]="activeTab === 'galpones' ? '0' : '-1'"
        aria-controls="panel-galpones"
      >
        Galpones
      </button>
    </div>

    <!-- ========= PESTAÃ‘A: GRANJAS ========= -->
    <section
      id="panel-granjas"
      role="tabpanel"
      aria-labelledby="tab-granjas"
      *ngIf="activeTab === 'granjas'"
    >
      <!-- Filtros -->
      <div class="ux-card mb-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 p-4">
          <div>
            <label for="filtro-regional" class="ux-label">Regional</label>
            <select id="filtro-regional" class="ux-input" [(ngModel)]="filtroRegionalId">
              <option [ngValue]="null">Todas</option>
              <option *ngFor="let r of regionOptions" [ngValue]="r.id">{{ r.label }}</option>
            </select>
          </div>

          <div>
            <label for="filtro-nombre" class="ux-label">Nombre de la granja</label>
            <div class="ux-input-icon">
              <fa-icon [icon]="['fas','magnifying-glass']" aria-hidden="true"></fa-icon>
              <input
                id="filtro-nombre"
                class="ux-input"
                type="text"
                [(ngModel)]="filtroNombre"
                placeholder="Ej: Granja San Pedro"
              />
            </div>
          </div>

          <div>
            <label for="filtro-estado" class="ux-label">Estado</label>
            <select id="filtro-estado" class="ux-input" [(ngModel)]="filtroEstado">
              <option [ngValue]="''">Todos</option>
              <option *ngFor="let s of statusOptions" [ngValue]="s">{{ s }}</option>
            </select>
          </div>

          <div class="flex items-end justify-end">
            <button (click)="openModal()" class="btn-primary w-full md:w-auto">
              <fa-icon [icon]="faPlus" class="mr-2" aria-hidden="true"></fa-icon>
              Nueva Granja
            </button>
          </div>
        </div>
      </div>

      <!-- Tabla -->
      <div class="ux-card">
        <div class="ux-scroll">
          <table class="ux-table">
            <caption class="sr-only">Listado de granjas</caption>
            <thead>
              <tr>
                <th>ID</th>
                <th>CompaÃ±Ã­a</th>
                <th>Nombre</th>
                <th>Regional</th>
                <th>Estado</th>
                <th>Departamento</th>
                <th>Ciudad</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let f of farmsFiltradas; trackBy: trackByFarm" class="ux-row">
                <td>{{ f.id }}</td>
                <td>{{ companyName(f.companyId) }}</td>
                <td class="font-medium text-slate-800">{{ f.name }}</td>
                <td>{{ regionalLabel(f.regionalId) }}</td>
                <td>{{ f.status }}</td>
                <td>{{ departamentoNombre(f.departamentoId) }}</td>
                <td>{{ ciudadNombre(f.ciudadId) }}</td>
                <td class="text-center">
                  <div class="inline-flex items-center gap-2">
                    <button type="button" (click)="openModal(f)" class="icon-btn" title="Editar">
                      <fa-icon [icon]="faPen" aria-hidden="true"></fa-icon>
                    </button>
                    <button type="button" (click)="delete(f.id)" class="icon-btn danger" title="Eliminar">
                      <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
                    </button>
                  </div>
                </td>
              </tr>

              <tr *ngIf="farmsFiltradas.length === 0">
                <td colspan="8" class="empty-state">
                  <div class="empty-illustration">ðŸ«¥</div>
                  <p>No hay granjas para mostrar.</p>
                  <button (click)="openModal()" class="btn-secondary mt-2">
                    <fa-icon [icon]="faPlus" class="mr-2" aria-hidden="true"></fa-icon>
                    Crear la primera
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="loading" class="loading-overlay" aria-live="polite">
          <div class="spinner"></div>
          Cargandoâ€¦
        </div>
      </div>
    </section>

    <!-- ========= PESTAÃ‘A: NÃšCLEOS ========= -->
    <section
      id="panel-nucleos"
      role="tabpanel"
      aria-labelledby="tab-nucleos"
      *ngIf="activeTab === 'nucleos'"
    >
      <!-- IncrustaciÃ³n directa. Pasa embedded=true para ocultar su sidebar. -->
      <app-nucleo-list [embedded]="true"></app-nucleo-list>
    </section>

    <!-- ========= PESTAÃ‘A: GALPONES ========= -->
    <section
      id="panel-galpones"
      role="tabpanel"
      aria-labelledby="tab-galpones"
      *ngIf="activeTab === 'galpones'"
    >
      <app-galpon-list [embedded]="true"></app-galpon-list>
    </section>

  </div>
</div>

<!-- Modal fuera del scroll -->
<div
  *ngIf="modalOpen"
  class="ux-modal"
  role="dialog"
  aria-modal="true"
  aria-labelledby="farm-title"
>
  <div class="ux-modal__panel" style="max-width: 820px;">
    <div class="ux-modal__header">
      <h2 id="farm-title" class="ux-title">
        {{ editing ? 'Editar Granja' : 'Nueva Granja' }}
      </h2>
      <button type="button" (click)="modalOpen = false" class="btn-muted" aria-label="Cerrar">Cerrar</button>
    </div>

    <!-- Atajos dentro del modal (sin router) -->
    <nav class="ux-tabs mb-4" role="tablist" aria-label="Atajos de mÃ³dulos">
      <button
        type="button"
        class="ux-tab"
        [class.active]="activeTab === 'granjas'"
        (click)="activeTab = 'granjas'"
      >
        Granja
      </button>
      <button
        type="button"
        class="ux-tab"
        (click)="activeTab = 'nucleos'; modalOpen = false"
      >
        NÃºcleos
      </button>
      <button
        type="button"
        class="ux-tab"
        (click)="activeTab = 'galpones'; modalOpen = false"
      >
        Galpones
      </button>
    </nav>

    <form [formGroup]="form" (ngSubmit)="save()" class="grid grid-cols-1 gap-4" novalidate>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="ux-label">Nombre <span class="req">*</span></label>
          <input formControlName="name" class="ux-input" />
        </div>

        <div>
          <label class="ux-label">CompaÃ±Ã­a <span class="req">*</span></label>
          <select formControlName="companyId" class="ux-input">
            <option [ngValue]="null">Seleccioneâ€¦</option>
            <option *ngFor="let c of companyOptions" [ngValue]="c.id">{{ c.name }}</option>
          </select>
        </div>

        <div>
          <label class="ux-label">Regional <span class="req">*</span></label>
          <select formControlName="regionalId" class="ux-input">
            <option [ngValue]="null">Seleccioneâ€¦</option>
            <option *ngFor="let r of regionOptions" [ngValue]="r.id">{{ r.label }}</option>
          </select>
        </div>

        <div>
          <label class="ux-label">Estado <span class="req">*</span></label>
          <select formControlName="status" class="ux-input">
            <option [ngValue]="''">Seleccioneâ€¦</option>
            <option *ngFor="let s of statusOptions" [ngValue]="s">{{ s }}</option>
          </select>
        </div>

        <div>
          <label class="ux-label">Departamento <span class="req">*</span></label>
          <select formControlName="departamentoId" class="ux-input" (change)="onDepartamentoChange()">
            <option [ngValue]="null">Seleccioneâ€¦</option>
            <option *ngFor="let d of departamentos" [ngValue]="d.departamentoId">{{ d.departamentoNombre }}</option>
          </select>
        </div>

        <div>
          <label class="ux-label">Ciudad <span class="req">*</span></label>
          <select formControlName="ciudadId" class="ux-input">
            <option [ngValue]="null">Seleccioneâ€¦</option>
            <option *ngFor="let c of ciudades" [ngValue]="c.municipioId">{{ c.municipioNombre }}</option>
          </select>
        </div>
      </div>

      <div class="ux-actions">
        <button type="button" (click)="modalOpen = false" class="btn-muted">Cancelar</button>
        <button type="submit" [disabled]="form.invalid || loading" class="btn-primary">
          {{ editing ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>
    </form>
  </div>
</div>
