<div class="flex h-screen" [attr.aria-busy]="loading ? 'true' : null">
  <div class="flex-1 p-6 bg-warm-gray-100 overflow-auto ux-page">
    <!-- Header -->
    <div class="ux-header">
      <button (click)="openModal()" class="btn-primary">
        <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
        <span>Nueva Granja</span>
      </button>
    </div>

    <!-- Filtros -->
    <div class="ux-card p-4 mb-4">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
        <!-- Regional (string) -->
        <div class="lg:col-span-3">
          <label for="f-regional" class="ux-label">Regional</label>
          <select id="f-regional" class="ux-select"
                  [(ngModel)]="selectedRegional"
                  (ngModelChange)="recomputeList()">
            <option [ngValue]="null">Todas</option>
            <option *ngFor="let r of regionales" [ngValue]="r">{{ r }}</option>
          </select>
        </div>

        <!-- Nombre exacto -->
        <div class="lg:col-span-3">
          <label for="f-nombre" class="ux-label">Nombre de la granja</label>
          <input id="f-nombre" class="ux-input"
                 [(ngModel)]="filtroNombre"
                 (ngModelChange)="recomputeList()"
                 placeholder="Ej: Granja San Pedro" />
        </div>

        <!-- Estado -->
        <div class="lg:col-span-2">
          <label for="f-estado" class="ux-label">Estado</label>
          <select id="f-estado" class="ux-select"
                  [(ngModel)]="filtroEstado"
                  (ngModelChange)="recomputeList()">
            <option [ngValue]="''">Todos</option>
            <option [ngValue]="'A'">Activa</option>
            <option [ngValue]="'I'">Inactiva</option>
          </select>
        </div>

        <!-- B√∫squeda libre -->
        <div class="lg:col-span-3">
          <label for="f-search" class="ux-label">Buscar</label>
          <div class="ux-search">
            <fa-icon [icon]="['fas','magnifying-glass']" class="ux-search__icon" aria-hidden="true"></fa-icon>
            <input id="f-search" type="text" class="ux-input"
                   [(ngModel)]="filtroTexto"
                   (ngModelChange)="recomputeList()"
                   placeholder="Por nombre, regional, compa√±√≠a, depto o ciudad‚Ä¶" />
          </div>
        </div>

        <!-- Limpiar -->
        <div class="lg:col-span-1">
          <button class="btn-ghost w-full" (click)="resetFilters()">Limpiar</button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="ux-card">
      <div class="ux-scroll">
        <table class="ux-table">
          <caption class="sr-only">Listado de granjas</caption>
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Compa√±√≠a</th>
              <th scope="col">Nombre</th>
              <th scope="col">Regional</th>
              <th scope="col">Estado</th>
              <th scope="col">Departamento</th>
              <th scope="col">Ciudad</th>
              <th scope="col" class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let g of viewFarms; trackBy: trackByFarm">
              <td>{{ g.id }}</td>
              <td>{{ companyName(g.companyId) }}</td>
              <td class="uppercase">{{ g.name }}</td>
              <td>{{ g.regional || '' }}</td>
              <td>{{ g.status }}</td>
              <td>{{ g.department || '' }}</td>
              <td>{{ g.city || '' }}</td>
              <td class="text-center">
                <div class="inline-flex items-center gap-2">
                  <button class="icon-btn" title="Editar" (click)="openModal(g)">
                    <fa-icon [icon]="faPen"></fa-icon>
                  </button>
                  <button class="icon-btn danger" title="Eliminar" (click)="delete(g.id!)">
                    <fa-icon [icon]="faTrash"></fa-icon>
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="(viewFarms?.length ?? 0) === 0 && !loading">
              <td colspan="8" class="empty-state">
                <div class="empty-illustration">üè°</div>
                <p>No hay granjas que coincidan con los filtros.</p>
                <button (click)="openModal()" class="btn-secondary mt-2">
                  <fa-icon [icon]="faPlus"></fa-icon> Crear la primera
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Overlay de carga -->
      <div *ngIf="loading" class="loading-overlay" aria-live="polite">
        <div class="spinner"></div> Cargando‚Ä¶
      </div>
    </div>

    <!-- MODAL: Crear/Editar Granja -->
    <div *ngIf="modalOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="farm-modal-title">
      <div class="ux-modal__panel">
        <div class="ux-modal__header">
          <h2 id="farm-modal-title" class="ux-title">{{ editing ? 'Editar Granja' : 'Nueva Granja' }}</h2>
          <button type="button" (click)="cancel()" class="btn-muted">Cerrar</button>
        </div>

        <form [formGroup]="form" (ngSubmit)="save()" class="grid grid-cols-1 md:grid-cols-2 gap-4" novalidate>
          <!-- ID (solo lectura; consecutivo sugerido por el front) -->
          <div>
            <label class="ux-label">ID (sugerido)</label>
            <input formControlName="id"
                   class="ux-input"
                   [readonly]="true"
                   [attr.aria-readonly]="true" />
            <p class="ux-help">
              N√∫mero sugerido (m√°ximo ID actual + 1). No es editable por el usuario.
            </p>
          </div>

          <!-- Compa√±√≠a -->
          <div>
            <label class="ux-label">Compa√±√≠a <span class="req">*</span></label>
            <select formControlName="companyId" class="ux-input"
                    [class.is-invalid]="form.get('companyId')?.invalid && form.get('companyId')?.touched">
              <option [ngValue]="null">Seleccione‚Ä¶</option>
              <option *ngFor="let c of companies" [ngValue]="c.id">{{ c.name }}</option>
            </select>
          </div>

          <!-- Nombre -->
          <div class="md:col-span-2">
            <label class="ux-label">Nombre <span class="req">*</span></label>
            <input formControlName="name" class="ux-input"
                   placeholder="Ej. Granja Central"
                   [class.is-invalid]="form.get('name')?.invalid && form.get('name')?.touched" />
          </div>

          <!-- Regional (texto) -->
          <div>
            <label class="ux-label">Regional</label>
            <select formControlName="regional" class="ux-input">
              <option [ngValue]="''">Seleccione‚Ä¶</option>
              <option *ngFor="let r of regionales" [ngValue]="r">{{ r }}</option>
            </select>
          </div>

          <!-- Estado -->
          <div>
            <label class="ux-label">Estado</label>
            <select formControlName="status" class="ux-input">
              <option [ngValue]="'A'">Activa</option>
              <option [ngValue]="'I'">Inactiva</option>
            </select>
          </div>

          <!-- ====== Cascada Pa√≠s ‚Üí Departamento ‚Üí Ciudad ====== -->
          <!-- Pa√≠s (UI; carga Departamentos) -->
          <div>
            <label class="ux-label">Pa√≠s</label>
            <select formControlName="paisId" class="ux-input" (change)="onPaisChange()">
              <option [ngValue]="null">Seleccione‚Ä¶</option>
              <option *ngFor="let p of paises" [ngValue]="p.paisId">
                {{ p.paisNombre }}
              </option>
            </select>
            <p class="ux-help">Al seleccionar un pa√≠s, se cargar√°n sus Departamentos.</p>
          </div>

          <!-- Departamento -->
          <div>
            <label class="ux-label">Departamento</label>
            <select formControlName="departamentoId" class="ux-input" (change)="onDepartamentoChange()">
              <option [ngValue]="null">Seleccione‚Ä¶</option>
              <option *ngFor="let d of departamentos" [ngValue]="d.departamentoId">
                {{ d.departamentoNombre }}
              </option>
            </select>
          </div>

          <!-- Ciudad -->
          <div>
            <label class="ux-label">Ciudad</label>
            <select formControlName="ciudadId" class="ux-input">
              <option [ngValue]="null">Seleccione‚Ä¶</option>
              <option *ngFor="let c of ciudades" [ngValue]="c.municipioId">
                {{ c.municipioNombre }}
              </option>
            </select>
          </div>


          <!-- Meta (si edici√≥n) -->
          <div class="md:col-span-2 ux-meta" *ngIf="editing?.createdAt || editing?.updatedAt">
            <div class="ux-meta__item" *ngIf="editing?.createdAt"><strong>Creado:</strong> {{ editing?.createdAt | date:'short' }}</div>
            <div class="ux-meta__item" *ngIf="editing?.updatedAt"><strong>Actualizado:</strong> {{ editing?.updatedAt | date:'short' }}</div>
          </div>

          <!-- Acciones -->
          <div class="md:col-span-2 ux-actions">
            <button type="button" class="btn-muted" (click)="cancel()">Cancelar</button>
            <button type="submit" class="btn-primary" [disabled]="form.invalid || loading">
              {{ editing ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- /MODAL -->
  </div>
</div>
