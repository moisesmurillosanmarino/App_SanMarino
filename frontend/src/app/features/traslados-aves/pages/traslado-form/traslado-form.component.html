<div class="ux-page" [attr.aria-busy]="isProcessing() ? 'true' : null">
  <app-sidebar class="ux-sidebar"></app-sidebar>

  <div class="ux-main">
    <!-- Header -->
    <header class="ux-header">
      <div class="ux-header__title">
        <h1>üöö Traslado de Aves</h1>
        <p class="ux-header__subtitle">Realizar traslado r√°pido entre lotes</p>
      </div>
      <div class="ux-header__actions">
        <button type="button" class="btn btn--ghost" (click)="navegarADashboard()">
          ‚Üê Volver al Dashboard
        </button>
        <button type="button" class="btn btn--outline" (click)="navegarAMovimientos()">
          üìã Ver Movimientos
        </button>
      </div>
    </header>

    <!-- Filtros de Lotes -->
    <section class="ux-card">
      <header class="ux-card__header">
        <h2>üîç Selecci√≥n de Lotes</h2>
      </header>
      
      <div class="ux-card__content">
        <div class="lote-selection-grid">
          <!-- Filtro Lote Origen -->
          <div class="lote-filter-section">
            <h3 class="section-title">üì§ Lote Origen</h3>
            <app-lote-filter
              [showLoteSelection]="true"
              [filterLabel]="'Filtros Lote Origen'"
              [placeholder]="'Buscar lote origen...'"
              (filterChange)="onFiltrosOrigenChange($event)"
              (loteSelected)="onLoteOrigenSelected($event)">
            </app-lote-filter>
          </div>

          <!-- Filtro Lote Destino -->
          <div class="lote-filter-section">
            <h3 class="section-title">üì• Lote Destino</h3>
            <app-lote-filter
              [showLoteSelection]="true"
              [filterLabel]="'Filtros Lote Destino'"
              [placeholder]="'Buscar lote destino...'"
              (filterChange)="onFiltrosDestinoChange($event)"
              (loteSelected)="onLoteDestinoSelected($event)">
            </app-lote-filter>
          </div>
        </div>
      </div>
    </section>

    <!-- Formulario de Traslado -->
    <section class="ux-card" *ngIf="loteOrigenSeleccionado() && loteDestinoSeleccionado()">
      <header class="ux-card__header">
        <h2>üîÑ Formulario de Traslado</h2>
        <button 
          type="button" 
          class="btn btn--ghost btn--sm" 
          (click)="limpiarFormulario()"
          [disabled]="isProcessing()">
          üóëÔ∏è Limpiar
        </button>
      </header>
      
      <div class="ux-card__content">
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="traslado-form">
          <!-- Selecci√≥n de Lotes -->
          <div class="lotes-section">
            <div class="lotes-grid">
              <!-- Lote Origen -->
              <div class="lote-field">
                <label for="loteOrigenId" class="ux-label">
                  üì¶ Lote Origen <span class="required">*</span>
                </label>
                <select 
                  id="loteOrigenId" 
                  class="ux-select" 
                  formControlName="loteOrigenId"
                  [class.is-invalid]="isFieldInvalid('loteOrigenId')">
                  <option value="">Seleccione lote origen</option>
                  <option *ngFor="let lote of lotesDisponibles()" [value]="lote">
                    {{ lote }}
                  </option>
                </select>
                <div class="field-error" *ngIf="isFieldInvalid('loteOrigenId')">
                  {{ getFieldError('loteOrigenId') }}
                </div>
              </div>
              
              <!-- Lote Destino -->
              <div class="lote-field">
                <label for="loteDestinoId" class="ux-label">
                  üì• Lote Destino <span class="required">*</span>
                </label>
                <select 
                  id="loteDestinoId" 
                  class="ux-select" 
                  formControlName="loteDestinoId"
                  [class.is-invalid]="isFieldInvalid('loteDestinoId')">
                  <option value="">Seleccione lote destino</option>
                  <option *ngFor="let lote of lotesDisponibles()" [value]="lote">
                    {{ lote }}
                  </option>
                </select>
                <div class="field-error" *ngIf="isFieldInvalid('loteDestinoId')">
                  {{ getFieldError('loteDestinoId') }}
                </div>
              </div>
            </div>

            <!-- Informaci√≥n de Inventarios -->
            <div class="inventarios-info" *ngIf="inventarioOrigen() || inventarioDestino()">
              <!-- Inventario Origen -->
              <div class="inventario-card inventario-card--origen" *ngIf="inventarioOrigen()">
                <h4>üì¶ Inventario Origen</h4>
                <div class="inventario-details">
                  <div class="detail-item">
                    <span class="detail-label">Lote:</span>
                    <span class="detail-value">{{ inventarioOrigen()!.loteId }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Granja:</span>
                    <span class="detail-value">{{ inventarioOrigen()!.granjaId }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">N√∫cleo:</span>
                    <span class="detail-value">{{ inventarioOrigen()!.nucleoId }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Hembras:</span>
                    <span class="detail-value detail-value--success">
                      {{ formatearNumero(inventarioOrigen()!.cantidadHembras) }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Machos:</span>
                    <span class="detail-value detail-value--info">
                      {{ formatearNumero(inventarioOrigen()!.cantidadMachos) }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Total:</span>
                    <span class="detail-value detail-value--primary">
                      {{ formatearNumero(inventarioOrigen()!.cantidadHembras + inventarioOrigen()!.cantidadMachos) }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Inventario Destino -->
              <div class="inventario-card inventario-card--destino" *ngIf="inventarioDestino()">
                <h4>üì• Inventario Destino</h4>
                <div class="inventario-details">
                  <div class="detail-item">
                    <span class="detail-label">Lote:</span>
                    <span class="detail-value">{{ inventarioDestino()!.loteId }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Granja:</span>
                    <span class="detail-value">{{ inventarioDestino()!.granjaId }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">N√∫cleo:</span>
                    <span class="detail-value">{{ inventarioDestino()!.nucleoId }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Hembras:</span>
                    <span class="detail-value detail-value--success">
                      {{ formatearNumero(inventarioDestino()!.cantidadHembras) }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Machos:</span>
                    <span class="detail-value detail-value--info">
                      {{ formatearNumero(inventarioDestino()!.cantidadMachos) }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Total:</span>
                    <span class="detail-value detail-value--primary">
                      {{ formatearNumero(inventarioDestino()!.cantidadHembras + inventarioDestino()!.cantidadMachos) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cantidades a Trasladar -->
          <div class="cantidades-section">
            <h3>üî¢ Cantidades a Trasladar</h3>
            
            <div class="cantidades-grid">
              <!-- Cantidad Hembras -->
              <div class="cantidad-field">
                <label for="cantidadHembras" class="ux-label">
                  üêî Cantidad Hembras <span class="required">*</span>
                </label>
                <div class="input-with-actions">
                  <input 
                    type="number" 
                    id="cantidadHembras" 
                    class="ux-input" 
                    formControlName="cantidadHembras" 
                    min="0"
                    [max]="inventarioOrigen()?.cantidadHembras || 999999"
                    [class.is-invalid]="isFieldInvalid('cantidadHembras')">
                  <button 
                    type="button" 
                    class="btn btn--ghost btn--sm"
                    (click)="trasladarTodasLasHembras()"
                    [disabled]="!inventarioOrigen()"
                    title="Trasladar todas las hembras">
                    Todas
                  </button>
                </div>
                <div class="field-error" *ngIf="isFieldInvalid('cantidadHembras')">
                  {{ getFieldError('cantidadHembras') }}
                </div>
                <div class="field-hint" *ngIf="inventarioOrigen()">
                  Disponibles: {{ formatearNumero(inventarioOrigen()!.cantidadHembras) }}
                </div>
              </div>
              
              <!-- Cantidad Machos -->
              <div class="cantidad-field">
                <label for="cantidadMachos" class="ux-label">
                  üêì Cantidad Machos <span class="required">*</span>
                </label>
                <div class="input-with-actions">
                  <input 
                    type="number" 
                    id="cantidadMachos" 
                    class="ux-input" 
                    formControlName="cantidadMachos" 
                    min="0"
                    [max]="inventarioOrigen()?.cantidadMachos || 999999"
                    [class.is-invalid]="isFieldInvalid('cantidadMachos')">
                  <button 
                    type="button" 
                    class="btn btn--ghost btn--sm"
                    (click)="trasladarTodosLosMachos()"
                    [disabled]="!inventarioOrigen()"
                    title="Trasladar todos los machos">
                    Todos
                  </button>
                </div>
                <div class="field-error" *ngIf="isFieldInvalid('cantidadMachos')">
                  {{ getFieldError('cantidadMachos') }}
                </div>
                <div class="field-hint" *ngIf="inventarioOrigen()">
                  Disponibles: {{ formatearNumero(inventarioOrigen()!.cantidadMachos) }}
                </div>
              </div>
            </div>

            <!-- Acciones R√°pidas -->
            <div class="quick-actions" *ngIf="inventarioOrigen()">
              <button 
                type="button" 
                class="btn btn--outline btn--sm"
                (click)="trasladarTodo()">
                üîÑ Trasladar Todo
              </button>
            </div>
          </div>

          <!-- Observaciones -->
          <div class="observaciones-section">
            <label for="observaciones" class="ux-label">üìù Observaciones</label>
            <textarea 
              id="observaciones" 
              class="ux-textarea" 
              formControlName="observaciones" 
              rows="3" 
              placeholder="Motivo del traslado, observaciones adicionales...">
            </textarea>
          </div>

          <!-- Resumen del Traslado -->
          <div class="resumen-traslado" *ngIf="totalATrasladas() > 0">
            <h4>üìä Resumen del Traslado</h4>
            <div class="resumen-content">
              <div class="resumen-item">
                <span class="resumen-label">Total a trasladar:</span>
                <span class="resumen-value resumen-value--primary">
                  {{ formatearNumero(totalATrasladas()) }} aves
                </span>
              </div>
              <div class="resumen-item">
                <span class="resumen-label">Detalle:</span>
                <span class="resumen-value">
                  {{ formatearNumero(form.get('cantidadHembras')?.value || 0) }} hembras + 
                  {{ formatearNumero(form.get('cantidadMachos')?.value || 0) }} machos
                </span>
              </div>
              <div class="resumen-item" *ngIf="form.get('loteOrigenId')?.value && form.get('loteDestinoId')?.value">
                <span class="resumen-label">Movimiento:</span>
                <span class="resumen-value">
                  {{ form.get('loteOrigenId')?.value }} ‚Üí {{ form.get('loteDestinoId')?.value }}
                </span>
              </div>
            </div>
          </div>

          <!-- Mensajes de Estado -->
          <div class="status-messages">
            <!-- Error -->
            <div class="alert alert--danger" *ngIf="hasError()">
              <div class="alert__icon">‚ö†Ô∏è</div>
              <div class="alert__content">
                <strong>Error:</strong> {{ error() }}
              </div>
            </div>

            <!-- √âxito -->
            <div class="alert alert--success" *ngIf="hasSuccess()">
              <div class="alert__icon">‚úÖ</div>
              <div class="alert__content">
                <strong>¬°√âxito!</strong> {{ success()!.message }}
                <div class="success-details" *ngIf="success()!.inventarioOrigenActualizado">
                  <p><strong>Inventario actualizado:</strong></p>
                  <ul>
                    <li>
                      <strong>{{ success()!.inventarioOrigenActualizado!.loteId }}:</strong>
                      {{ formatearNumero(success()!.inventarioOrigenActualizado!.cantidadHembras) }} hembras, 
                      {{ formatearNumero(success()!.inventarioOrigenActualizado!.cantidadMachos) }} machos
                    </li>
                    <li>
                      <strong>{{ success()!.inventarioDestinoActualizado!.loteId }}:</strong>
                      {{ formatearNumero(success()!.inventarioDestinoActualizado!.cantidadHembras) }} hembras, 
                      {{ formatearNumero(success()!.inventarioDestinoActualizado!.cantidadMachos) }} machos
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de Acci√≥n -->
          <div class="form-actions">
            <button 
              type="button" 
              class="btn btn--ghost" 
              (click)="limpiarFormulario()"
              [disabled]="isProcessing()">
              üóëÔ∏è Limpiar
            </button>
            <button 
              type="submit" 
              class="btn btn--primary" 
              [disabled]="!isFormValid() || isProcessing() || totalATrasladas() === 0">
              <span class="btn-spinner" *ngIf="isProcessing()"></span>
              <span *ngIf="!isProcessing()">üöö</span>
              {{ isProcessing() ? 'Procesando...' : 'Realizar Traslado' }}
            </button>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>
