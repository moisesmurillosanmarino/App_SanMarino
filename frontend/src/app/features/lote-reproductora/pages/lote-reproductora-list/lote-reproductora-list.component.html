<div class="flex h-screen">
  <app-sidebar class="w-64"></app-sidebar>

  <div class="main-content" [attr.aria-busy]="loading ? 'true' : null">
    <!-- Header -->
    <div class="header">
      <div class="header__title">
        <h1>Lotes Reproductora</h1>
        <span class="summary-chip ml-2" *ngIf="selectedLoteId">{{ registros?.length || 0 }} registro(s)</span>
      </div>

      <!-- Bot√≥n NUEVO deshabilitado si no hay Lote seleccionado -->
      <button
        class="btn-primary"
        (click)="openNew()"
        [disabled]="!selectedLoteId"
        [attr.aria-disabled]="!selectedLoteId ? 'true' : null"
        [title]="!selectedLoteId ? 'Primero selecciona el Lote al que se asignar√°' : 'Crear nuevo Lote Reproductora'">
        <fa-icon [icon]="faPlus" class="mr-2" aria-hidden="true"></fa-icon>
        Nuevo
      </button>
    </div>

    <!-- Filtros en cascada -->
    <div class="ux-card mb-4" role="group" aria-labelledby="filtros-title">
      <div class="sr-only" id="filtros-title">Filtros en cascada</div>

      <div class="filters">
        <div class="filter">
          <label class="ux-label" for="sel-granja">Granja</label>
          <select id="sel-granja" [(ngModel)]="selectedGranjaId" (change)="onGranjaChange()" class="ux-select">
            <option [ngValue]="null">‚Äî Seleccione ‚Äî</option>
            <option *ngFor="let g of granjas; trackBy: trackByIdx" [ngValue]="g.id">{{ g.name }}</option>
          </select>
        </div>

        <div class="filter">
          <label class="ux-label" for="sel-nucleo">N√∫cleo</label>
          <select id="sel-nucleo" [(ngModel)]="selectedNucleoId" (change)="onNucleoChange()" class="ux-select"
                  [disabled]="!selectedGranjaId" [attr.aria-disabled]="!selectedGranjaId ? 'true' : null">
            <option [ngValue]="null">‚Äî Seleccione ‚Äî</option>
            <option *ngFor="let n of nucleos; trackBy: trackByIdx" [ngValue]="n.nucleoId">{{ n.nucleoNombre }}</option>
          </select>
        </div>

        <div class="filter">
          <label class="ux-label" for="sel-lote">Lote</label>
          <select id="sel-lote" [(ngModel)]="selectedLoteId" (change)="onLoteChange()" class="ux-select"
                  [disabled]="!selectedNucleoId" [attr.aria-disabled] = "!selectedNucleoId ? 'true' : null"
                  aria-describedby="hint-lote">
            <option [ngValue]="null">‚Äî Seleccione ‚Äî</option>
            <option *ngFor="let l of lotes; trackBy: trackByIdx" [ngValue]="l.loteId">{{ l.loteNombre }}</option>
          </select>
          <small id="hint-lote" class="text-[12px] text-warm-gray-700">
            Selecciona el Lote para habilitar ‚ÄúNuevo‚Äù.
          </small>
        </div>
      </div>
    </div>

    <!-- Aviso cuando NO hay Lote seleccionado -->
    <div *ngIf="!selectedLoteId" class="ux-card ux-card--soft mb-4" role="status" aria-live="polite">
      <div class="summary-grid">
        <div class="summary-item">
          <span class="summary-label">Estado</span>
          <span class="summary-value">Lote sin seleccionar</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Siguiente paso</span>
          <span class="summary-value">Elige un Lote en el filtro para crear un Lote Reproductora</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Acci√≥n</span>
          <span class="summary-chip">‚ÄúNuevo‚Äù deshabilitado</span>
        </div>
      </div>
    </div>

    <!-- Contexto cuando S√ç hay Lote seleccionado -->
    <div *ngIf="selectedLoteId" class="ux-card mb-4" role="status" aria-live="polite">
      <div class="summary-grid">
        <div class="summary-item">
          <span class="summary-label">Creando para</span>
          <span class="summary-chip">Lote #{{ selectedLoteId }}</span>
        </div>
        <div class="summary-item" *ngIf="loteSeleccionado?.loteNombre">
          <span class="summary-label">Nombre del lote</span>
          <span class="summary-value">{{ loteSeleccionado?.loteNombre }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Atajo</span>
          <span class="summary-value">Pulsa ‚ÄúNuevo‚Äù para registrar la reproductora</span>
        </div>
      </div>
    </div>

    <!-- üê£ Resumen del lote seleccionado -->
    <div *ngIf="loteSeleccionado" class="ux-card ux-card--soft mb-4">
      <div class="summary-grid">
        <div class="summary-item">
          <span class="summary-label">Lote ID</span>
          <span class="summary-value">{{ loteSeleccionado.loteId }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Nombre</span>
          <span class="summary-value">{{ loteSeleccionado.loteNombre }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Granja ID</span>
          <span class="summary-value">{{ loteSeleccionado.granjaId }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Hembras</span>
          <span class="summary-chip">{{ loteSeleccionado.hembrasL ?? 0 }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Machos</span>
          <span class="summary-chip">{{ loteSeleccionado.machosL ?? 0 }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Mixtas</span>
          <span class="summary-chip">{{ loteSeleccionado.mixtas ?? 0 }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Aves encasetadas</span>
          <span class="summary-value">{{ loteSeleccionado.avesEncasetadas ?? 0 }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Peso H</span>
          <span class="summary-value">{{ (loteSeleccionado.pesoInicialH ?? 0) | number:'1.0-3' }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Peso M</span>
          <span class="summary-value">{{ (loteSeleccionado.pesoInicialM ?? 0) | number:'1.0-3' }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Peso Mixto</span>
          <span class="summary-value">{{ (loteSeleccionado.pesoMixto ?? 0) | number:'1.0-3' }}</span>
        </div>
      </div>
    </div>

    <!-- Tabla principal -->
    <div class="ux-card">
      <div class="ux-scroll">
        <table class="ux-table">
          <caption class="sr-only">Lotes Reproductora</caption>

          <thead>
            <tr class="group-row">
              <th colspan="2" class="text-center">üìã Lote Reproductora</th>
              <th colspan="3" class="text-center">üê£ Cantidad de aves</th>
              <th colspan="3" class="text-center">‚öñÔ∏è Peso llegada</th>
              <th class="text-center">Acciones</th>
            </tr>
            <tr>
              <th>Lote Reproductora</th>
              <th>Incubadora</th>
              <th>Machos</th>
              <th>Hembras</th>
              <th>Mixtas</th>
              <th>Peso M</th>
              <th>Peso H</th>
              <th>Peso Mixto</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <!-- Cargando -->
            <tr *ngIf="loading" aria-live="polite">
              <td colspan="9" class="empty-state">
                <div class="spinner"></div>
                Cargando datos‚Ä¶
              </td>
            </tr>

            <!-- Vac√≠o -->
            <tr *ngIf="!loading && (!registros || !registros.length)">
              <td colspan="9" class="empty-state">
                <div class="empty-illustration">ü´•</div>
                <p *ngIf="!selectedLoteId">Selecciona un Lote para comenzar.</p>
                <p *ngIf="selectedLoteId">Sin registros para este Lote.</p>

                <button class="btn-secondary mt-2" (click)="openNew()" [disabled]="!selectedLoteId">
                  <fa-icon [icon]="faPlus" class="mr-2" aria-hidden="true"></fa-icon>
                  Crear el primero
                </button>
              </td>
            </tr>

            <!-- Filas -->
            <tr *ngFor="let r of registros; trackBy: trackByRegistro" class="ux-row">
              <td>{{ r.nombreLote }}</td>
              <td>{{ r.reproductoraId }}</td>
              <td><span class="summary-chip">{{ r.m ?? 0 }}</span></td>
              <td><span class="summary-chip">{{ r.h ?? 0 }}</span></td>
              <td><span class="summary-chip">{{ r.mixtas ?? 0 }}</span></td>
              <td>{{ (r.pesoInicialM ?? 0) | number:'1.0-3' }}</td>
              <td>{{ (r.pesoInicialH ?? 0) | number:'1.0-3' }}</td>
              <td>{{ (r.pesoMixto ?? 0)     | number:'1.0-3' }}</td>
              <td class="text-center">
                <div class="actions">
                  <button class="icon-btn" title="Ver" aria-label="Ver" (click)="view(r)">
                    <fa-icon [icon]="faEye" aria-hidden="true"></fa-icon>
                  </button>
                  <button class="icon-btn" title="Editar" aria-label="Editar" (click)="edit(r)">
                    <fa-icon [icon]="faPen" aria-hidden="true"></fa-icon>
                  </button>
                  <button class="icon-btn danger" title="Eliminar" aria-label="Eliminar"
                          (click)="delete(r.loteId, r.reproductoraId)">
                    <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Overlay de carga sobre la card -->
      <div *ngIf="loading" class="loading-overlay" aria-live="polite">
        <div class="spinner"></div>
        Cargando‚Ä¶
      </div>
    </div>

    <!-- Modal Detalle -->
    <div *ngIf="detalleOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="detalle-title">
      <div class="ux-modal__panel">
        <div class="ux-modal__header">
          <h2 id="detalle-title">Detalle del Lote Reproductora</h2>
          <button class="ux-modal__close" (click)="closeDetalle()" aria-label="Cerrar">√ó</button>
        </div>

        <div class="ux-modal__body">
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label">Lote</span>
              <span class="summary-value">{{ detalleData?.nombreLote }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Incubadora</span>
              <span class="summary-value">{{ detalleData?.reproductoraId }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Machos</span>
              <span class="summary-chip">{{ detalleData?.m ?? 0 }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Hembras</span>
              <span class="summary-chip">{{ detalleData?.h ?? 0 }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Mixtas</span>
              <span class="summary-chip">{{ detalleData?.mixtas ?? 0 }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Peso M</span>
              <span class="summary-value">{{ (detalleData?.pesoInicialM ?? 0) | number:'1.0-3' }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Peso H</span>
              <span class="summary-value">{{ (detalleData?.pesoInicialH ?? 0) | number:'1.0-3' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Crear/Editar -->
    <div *ngIf="modalOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="ux-modal__panel ux-modal__panel--xl">
        <div class="ux-modal__header">
          <h2 id="modal-title">{{ editing ? 'Editar' : (bulkMode ? 'Nuevo (m√∫ltiple)' : 'Nuevo') }} Lote Reproductora</h2>
          <button class="ux-modal__close" (click)="cancel()" aria-label="Cerrar">√ó</button>
        </div>

        <!-- Cuerpo scrollable -->
        <div class="ux-modal__body">
          <!-- Toggle single / multiple -->
          <div *ngIf="!editing" class="ux-card ux-card--soft mb-4">
            <div class="flex items-center gap-4">
              <label class="ux-label mb-0">Modo:</label>
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" class="ux-switch" [(ngModel)]="bulkMode" (change)="bulkMode ? regenerateIncubadoras(bulkCount) : null">
                <span>{{ bulkMode ? 'M√∫ltiple' : 'Uno' }}</span>
              </label>

              <ng-container *ngIf="bulkMode">
                <div class="flex items-center gap-2">
                  <label class="ux-label mb-0" for="bulk-count">Cantidad incubadoras</label>
                  <input id="bulk-count" type="number" class="ux-input w-24" min="1" max="50"
                         [(ngModel)]="bulkCount"
                         (change)="regenerateIncubadoras(bulkCount)"
                         (keyup.enter)="regenerateIncubadoras(bulkCount)" />
                  <button type="button" class="btn-secondary" (click)="regenerateIncubadoras(bulkCount)">Aplicar</button>
                  <button type="button" class="btn-ghost" (click)="addIncubadora()">+1</button>
                </div>
              </ng-container>
            </div>

            <div class="mt-3 text-sm text-warm-gray-700" *ngIf="selectedLoteId">
              Lote destino: <span class="summary-chip">#{{ selectedLoteId }}</span>
            </div>
          </div>

          <!-- SINGLE -->
          <form *ngIf="!bulkMode" [formGroup]="form" (ngSubmit)="save()" class="ux-form" novalidate>
            <div class="form-section__title">Datos generales</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="ux-label" for="inp-nombre">Lote Reproductora</label>
                <input id="inp-nombre" class="ux-input" formControlName="nombreLote" />
              </div>
              <div>
                <label class="ux-label" for="inp-rep">Incubadora</label>
                <input id="inp-rep" class="ux-input" formControlName="reproductoraId" placeholder="Ej: Sanmarino" />
              </div>
              <div>
                <label class="ux-label" for="inp-fecha">Fecha Encasetamiento</label>
                <input id="inp-fecha" type="date" class="ux-input" formControlName="fechaEncasetamiento" />
                <small class="field-hint" *ngIf="form.get('fechaEncasetamiento')?.invalid && form.get('fechaEncasetamiento')?.touched">
                  La fecha es requerida.
                </small>
              </div>
            </div>

            <div class="form-section__title">Cantidad de aves</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div><label class="ux-label" for="inp-m">Machos</label><input id="inp-m" type="number" class="ux-input" formControlName="m" inputmode="numeric"/></div>
              <div><label class="ux-label" for="inp-h">Hembras</label><input id="inp-h" type="number" class="ux-input" formControlName="h" inputmode="numeric"/></div>
              <div><label class="ux-label" for="inp-mixtas">Mixtas</label><input id="inp-mixtas" type="number" class="ux-input" formControlName="mixtas" inputmode="numeric"/></div>
            </div>

            <div class="form-section__title">Peso llegada</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label class="ux-label" for="inp-pm">Peso Machos</label><input id="inp-pm" type="number" class="ux-input" formControlName="pesoInicialM" step="0.001" inputmode="decimal"/></div>
              <div><label class="ux-label" for="inp-ph">Peso Hembras</label><input id="inp-ph" type="number" class="ux-input" formControlName="pesoInicialH" step="0.001" inputmode="decimal"/></div>
            </div>

            <div class="ux-modal__actions">
              <button type="button" class="btn-ghost" (click)="cancel()">Cancelar</button>
              <button type="submit" class="btn-primary" [disabled]="form.invalid">{{ editing ? 'Actualizar' : 'Guardar' }}</button>
            </div>
          </form>

          <!-- MULTIPLE -->
          <form *ngIf="bulkMode" class="ux-form" (ngSubmit)="save()" novalidate [formGroup]="form">
            <div formArrayName="incubadoras" class="space-y-6">
              <div *ngFor="let g of incubadoras.controls; let i = index; trackBy: trackByIdx" [formGroupName]="i" class="ux-card incubadora-card">
                <div class="flex items-center justify-between mb-2">
                  <div class="font-semibold">Incubadora #{{ i + 1 }}</div>
                  <button type="button" class="icon-btn danger" aria-label="Quitar" (click)="removeIncubadora(i)" *ngIf="incubadoras.length > 1">√ó</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="ux-label">Lote Reproductora</label>
                    <input class="ux-input" formControlName="nombreLote" />
                  </div>
                  <div>
                    <label class="ux-label">Incubadora</label>
                    <input class="ux-input" formControlName="reproductoraId" placeholder="Ej: Sanmarino-A" />
                  </div>
                  <div>
                    <label class="ux-label">Fecha Encasetamiento</label>
                    <input type="date" class="ux-input" formControlName="fechaEncasetamiento" />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                  <div><label class="ux-label">Machos</label><input type="number" class="ux-input" formControlName="m" inputmode="numeric"/></div>
                  <div><label class="ux-label">Hembras</label><input type="number" class="ux-input" formControlName="h" inputmode="numeric"/></div>
                  <div><label class="ux-label">Mixtas</label><input type="number" class="ux-input" formControlName="mixtas" inputmode="numeric"/></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                  <div><label class="ux-label">Peso Machos</label><input type="number" class="ux-input" formControlName="pesoInicialM" step="0.001" inputmode="decimal"/></div>
                  <div><label class="ux-label">Peso Hembras</label><input type="number" class="ux-input" formControlName="pesoInicialH" step="0.001" inputmode="decimal"/></div>
                </div>
              </div>
            </div>

            <div class="ux-modal__actions mt-6">
              <button type="button" class="btn-ghost" (click)="cancel()">Cancelar</button>
              <button type="submit" class="btn-primary">Guardar {{ incubadoras.length }} incubadora(s)</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
