<!-- src/app/features/galpon/pages/galpon-list/galpon-list.component.html -->
<div class="flex h-screen" [attr.aria-busy]="loading ? 'true' : null">
    <div class="flex" [class.h-screen]="!embedded">

</div>

  <div class="flex-1 p-6 bg-warm-gray-100 overflow-auto ux-page">
    <!-- Header -->
    <div class="ux-header">

      <button (click)="openModal()" class="btn-primary">
        <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
        <span>Nuevo Galp√≥n</span>
      </button>
    </div>

    <!-- Filtros en cascada + b√∫squeda -->
    <div class="ux-card p-4 mb-4">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
        <!-- Compa√±√≠a -->
        <div class="lg:col-span-3">
          <label for="g-company" class="ux-label">Compa√±√≠a</label>
          <select id="g-company" class="ux-select"
                  [(ngModel)]="selectedCompanyId"
                  (ngModelChange)="onCompanyChangeList($event)">
            <option [ngValue]="null">Todas</option>
            <option *ngFor="let c of companies" [ngValue]="c.id">{{ c.name }}</option>
          </select>
        </div>

        <!-- Granja (depende de compa√±√≠a) -->
        <div class="lg:col-span-3">
          <label for="g-farm" class="ux-label">Granja</label>
          <select id="g-farm" class="ux-select"
                  [(ngModel)]="selectedFarmId"
                  (ngModelChange)="onFarmChangeList($event)">
            <option [ngValue]="null">Todas</option>
            <option *ngFor="let f of farmsFilteredG" [ngValue]="f.id">{{ f.name }}</option>
          </select>
        </div>

        <!-- N√∫cleo (depende de granja/compa√±√≠a) -->
        <div class="lg:col-span-3">
          <label for="g-nucleo" class="ux-label">N√∫cleo</label>
          <select id="g-nucleo" class="ux-select"
                  [(ngModel)]="selectedNucleoId"
                  (ngModelChange)="onNucleoChangeList($event)">
            <option [ngValue]="null">Todos</option>
            <option *ngFor="let n of nucleosFilteredG" [ngValue]="n.nucleoId">
              {{ n.nucleoNombre }}
            </option>
          </select>
        </div>

        <!-- B√∫squeda -->
        <div class="lg:col-span-2">
          <label for="galpon-filter" class="ux-label">Buscar</label>
          <div class="ux-search">
            <fa-icon [icon]="['fas','magnifying-glass']" class="ux-search__icon" aria-hidden="true"></fa-icon>
            <input
              id="galpon-filter"
              type="text"
              [(ngModel)]="filtro"
              (ngModelChange)="recomputeList()"
              placeholder="Buscar por galp√≥n, n√∫cleo o granja‚Ä¶"
              class="ux-input"
              aria-label="Buscar galp√≥n"
            />
          </div>
        </div>

        <!-- Limpiar -->
        <div class="lg:col-span-1">
          <button class="btn-ghost w-full" (click)="resetListFilters()">Limpiar</button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="ux-card">
      <div class="ux-scroll">
        <table class="ux-table">
          <caption class="sr-only">Listado de galpones</caption>
          <thead>
            <tr>
              <th scope="col">Empresa</th>
              <th scope="col">Granja</th>
              <th scope="col">N√∫cleo</th>
              <th scope="col">Galp√≥n</th>
              <th scope="col">Ancho (m)</th>
              <th scope="col">Largo (m)</th>
              <th scope="col">√Årea (m¬≤)</th>
              <th scope="col">Tipo</th>
              <th scope="col" class="text-center">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let g of viewGalpones" class="ux-row">
              <td>{{ g.company.name }}</td>
              <td>{{ g.farm.name }}</td>
              <td>{{ g.nucleo.nucleoNombre }}</td>
              <td>{{ g.galponNombre }}</td>
              <td>{{ g.ancho || '‚Äì' }}</td>
              <td>{{ g.largo || '‚Äì' }}</td>
              <td>{{ getArea(g) }}</td>
              <td><span class="ux-badge">{{ g.tipoGalpon || '‚Äî' }}</span></td>
              <td class="text-center">
                <div class="inline-flex items-center gap-2">
                  <button (click)="openModal(g)" class="icon-btn" title="Editar">
                    <fa-icon [icon]="faPen" aria-hidden="true"></fa-icon>
                  </button>
                  <button (click)="showDetail(g)" class="icon-btn" title="Ver detalle">
                    <fa-icon [icon]="faEye" aria-hidden="true"></fa-icon>
                  </button>
                  <button (click)="delete(g.galponId)" class="icon-btn danger" title="Eliminar">
                    <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="(viewGalpones)?.length === 0 && !loading">
              <td colspan="9" class="empty-state">
                <div class="empty-illustration">üè†</div>
                <p>No hay galpones que coincidan con los filtros.</p>
                <button (click)="openModal()" class="btn-secondary mt-2">
                  <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
                  Crear el primero
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Overlay de carga -->
      <div *ngIf="loading" class="loading-overlay" aria-live="polite">
        <div class="spinner"></div>
        Cargando‚Ä¶
      </div>
    </div>

    <!-- MODAL: Crear/Editar -->
    <div *ngIf="modalOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="galpon-modal-title">
      <div class="ux-modal__panel">
        <div class="ux-modal__header">
          <h2 id="galpon-modal-title" class="ux-title">{{ editing ? 'Editar Galp√≥n' : 'Nuevo Galp√≥n' }}</h2>
          <button type="button" (click)="modalOpen = false" class="btn-muted">Cerrar</button>
        </div>

        <form [formGroup]="form" (ngSubmit)="save()" class="ux-modal__body grid grid-cols-1 md:grid-cols-2 gap-4" novalidate>
          <!-- ID (solo lectura en edici√≥n) -->
          <div>
            <label class="ux-label">ID Galp√≥n</label>
            <input formControlName="galponId" [readonly]="editing" class="ux-input" />
          </div>

          <div>
            <label class="ux-label">Nombre <span class="req">*</span></label>
            <input formControlName="galponNombre" class="ux-input"
                   [class.is-invalid]="form.get('galponNombre')?.invalid && form.get('galponNombre')?.touched" />
          </div>

          <div>
            <label class="ux-label">N√∫cleo <span class="req">*</span></label>
            <select formControlName="nucleoId" class="ux-input"
                    [class.is-invalid]="form.get('nucleoId')?.invalid && form.get('nucleoId')?.touched">
              <option value="">Seleccione‚Ä¶</option>
              <option *ngFor="let opt of nucleoOptions" [value]="opt.id">{{ opt.label }}</option>
            </select>
          </div>

          <!-- Hidden para enviar la granjaId (se llena autom√°tico al elegir n√∫cleo) -->
          <input type="hidden" formControlName="granjaId" />

          <div>
            <label class="ux-label">Granja</label>
            <input type="text" [value]="getGranjaNombreByNucleoId(form.get('nucleoId')?.value)" readonly class="ux-input ux-input--readonly" />
          </div>

          <div>
            <label class="ux-label">Ancho (m)</label>
            <input formControlName="ancho" class="ux-input" />
          </div>

          <div>
            <label class="ux-label">Largo (m)</label>
            <input formControlName="largo" class="ux-input" />
          </div>

          <div class="md:col-span-2">
            <label class="ux-label">Tipo de Galp√≥n</label>
            <select formControlName="tipoGalpon" class="ux-input">
              <option value="">Seleccione‚Ä¶</option>
              <option *ngFor="let opt of typegarponOptions" [value]="opt">{{ opt }}</option>
            </select>
          </div>

          <!-- Meta: solo en edici√≥n -->
          <div *ngIf="editing" class="md:col-span-2 ux-meta">
            <div class="ux-meta__item"><strong>Empresa:</strong> {{ editing!.company.name }} ({{ editing!.company.identifier }})</div>
            <div class="ux-meta__item"><strong>Granja:</strong> {{ editing!.farm.name }} (ID {{ editing!.farm.id }})</div>
            <div class="ux-meta__item"><strong>N√∫cleo:</strong> {{ editing!.nucleo.nucleoNombre }} ({{ editing!.nucleo.nucleoId }})</div>
            <div class="ux-meta__item"><strong>Creado:</strong> {{ editing!.createdAt | date:'short' }}</div>
            <div class="ux-meta__item"><strong>Actualizado:</strong> {{ editing!.updatedAt | date:'short' }}</div>
          </div>

          <div class="md:col-span-2 ux-actions">
            <button type="button" (click)="modalOpen = false" class="btn-muted">Cancelar</button>
            <button type="submit" [disabled]="form.invalid" class="btn-primary">
              {{ editing ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL: Detalle -->
    <div *ngIf="detailOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="detail-modal-title">
      <div class="ux-modal__panel">
        <div class="ux-modal__header">
          <h2 id="detail-modal-title" class="ux-title">Detalle del Galp√≥n</h2>
          <button type="button" (click)="detailOpen = false" class="btn-muted">Cerrar</button>
        </div>

        <div class="ux-modal__body grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div><strong>ID:</strong> {{ selectedDetail?.galponId }}</div>
          <div><strong>Nombre:</strong> {{ selectedDetail?.galponNombre }}</div>
          <div><strong>Tipo:</strong> {{ selectedDetail?.tipoGalpon || '‚Äî' }}</div>

          <div><strong>N√∫cleo:</strong> {{ selectedDetail?.nucleo?.nucleoNombre }} ({{ selectedDetail?.nucleo?.nucleoId }})</div>
          <div><strong>Granja:</strong> {{ selectedDetail?.farm?.name }} (ID {{ selectedDetail?.farm?.id }})</div>
          <div><strong>Empresa:</strong> {{ selectedDetail?.company?.name }}</div>

          <div><strong>Dimensiones:</strong> {{ selectedDetail?.ancho || '‚Äî' }} √ó {{ selectedDetail?.largo || '‚Äî' }} m</div>
          <div><strong>√Årea (m¬≤):</strong> {{ getArea(selectedDetail) }}</div>
          <div><strong>Auditor√≠a:</strong>
            C: {{ selectedDetail?.createdAt | date:'short' }} ‚Ä¢ U: {{ selectedDetail?.updatedAt | date:'short' }}
          </div>
        </div>

        <div class="ux-actions">
          <button type="button" (click)="detailOpen = false" class="btn-primary">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</div>
