<div class="flex h-screen" [attr.aria-busy]="loading ? 'true' : null">
  <app-sidebar class="w-64"></app-sidebar>

  <div class="flex-1 p-6 bg-warm-gray-100 overflow-auto ux-page">
    <!-- Header -->
    <div class="ux-header">
      <div class="ux-header__title">
        <h1 class="ux-title">Gesti√≥n de Galpones</h1>
        <p class="ux-subtitle">Administra galpones por n√∫cleo, granja y empresa.</p>
      </div>
      <button (click)="openModal()" class="btn-primary">
        <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
        <span>Nuevo Galp√≥n</span>
      </button>
    </div>

    <!-- Filtro -->
    <div class="ux-filter">
      <label for="galpon-filter" class="sr-only">Buscar galp√≥n</label>
      <div class="ux-search">
        <fa-icon [icon]="['fas','magnifying-glass']" class="ux-search__icon" aria-hidden="true"></fa-icon>
        <input
          id="galpon-filter"
          type="text"
          [(ngModel)]="filtro"
          placeholder="Buscar por galp√≥n, n√∫cleo, granja o empresa‚Ä¶"
          class="ux-input"
          aria-label="Buscar galp√≥n"
        />
      </div>
    </div>

    <!-- Tabla -->
    <div class="ux-card">
      <div class="ux-scroll">
        <table class="ux-table">
          <caption class="sr-only">Listado de galpones</caption>

          <thead>
            <tr>
              <th scope="col">Empresa</th>
              <th scope="col">Granja</th>
              <th scope="col">N√∫cleo</th>
              <th scope="col">Galp√≥n</th>
              <th scope="col">Ancho (m)</th>
              <th scope="col">Largo (m)</th>
              <th scope="col">Tipo</th>
              <th scope="col" class="text-center">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let g of galpones | galponFilter:filtro:allNucleos:farms:companies" class="ux-row">
              <td>{{ getCompanyNameByGalpon(g) }}</td>
              <td>{{ getGranjaNameByGalpon(g) }}</td>
              <td>{{ getNucleoNameByGalpon(g) }}</td>
              <td>{{ g.galponNombre }}</td>
              <td>{{ g.ancho }}</td>
              <td>{{ g.largo }}</td>
              <td>
                <span class="ux-badge">{{ g.tipoGalpon || '‚Äî' }}</span>
              </td>
              <td class="text-center">
                <div class="inline-flex items-center gap-2">
                  <button (click)="openModal(g)" class="icon-btn" title="Editar">
                    <fa-icon [icon]="faPen" aria-hidden="true"></fa-icon>
                  </button>
                  <button (click)="showDetail(g)" class="icon-btn" title="Ver detalle">
                    <fa-icon [icon]="faEye" aria-hidden="true"></fa-icon>
                  </button>
                  <button (click)="delete(g.galponId)" class="icon-btn danger" title="Eliminar">
                    <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="(galpones | galponFilter:filtro:allNucleos:farms:companies)?.length === 0">
              <td colspan="8" class="empty-state">
                <div class="empty-illustration">üè†</div>
                <p>No hay galpones que coincidan con el filtro.</p>
                <button (click)="openModal()" class="btn-secondary mt-2">
                  <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
                  Crear el primero
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Overlay de carga sobre la card -->
      <div *ngIf="loading" class="loading-overlay" aria-live="polite">
        <div class="spinner"></div>
        Cargando‚Ä¶
      </div>
    </div>

    <!-- MODAL: Crear/Editar -->
    <div *ngIf="modalOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="galpon-modal-title">
      <div class="ux-modal__panel">
        <div class="ux-modal__header">
          <h2 id="galpon-modal-title" class="ux-title">
            {{ editing ? 'Editar Galp√≥n' : 'Nuevo Galp√≥n' }}
          </h2>
          <button type="button" (click)="modalOpen = false" class="btn-muted">Cerrar</button>
        </div>

        <form [formGroup]="form" (ngSubmit)="save()" class="ux-modal__body grid grid-cols-1 md:grid-cols-2 gap-4" novalidate>
          <!-- ID (solo lectura) -->
          <div>
            <label class="ux-label">ID Galp√≥n</label>
            <input formControlName="galponId" readonly class="ux-input ux-input--readonly" />
          </div>

          <div>
            <label class="ux-label">Nombre <span class="req">*</span></label>
            <input formControlName="galponNombre" class="ux-input"
                   [class.is-invalid]="form.get('galponNombre')?.invalid && form.get('galponNombre')?.touched" />
          </div>

          <div>
            <label class="ux-label">N√∫cleo <span class="req">*</span></label>
            <select formControlName="galponNucleoId" class="ux-input"
                    [class.is-invalid]="form.get('galponNucleoId')?.invalid && form.get('galponNucleoId')?.touched">
              <option value="">Seleccione‚Ä¶</option>
              <option *ngFor="let opt of nucleoOptions" [value]="opt.id">{{ opt.label }}</option>
            </select>
          </div>

          <!-- Hidden para enviar la granjaId -->
          <input type="hidden" formControlName="granjaId" />

          <div>
            <label class="ux-label">Granja</label>
            <input type="text"
                   [value]="getGranjaNombreByNucleoId(form.get('galponNucleoId')?.value)"
                   readonly
                   class="ux-input ux-input--readonly" />
          </div>

          <div>
            <label class="ux-label">Ancho (m)</label>
            <input formControlName="ancho" class="ux-input" />
          </div>

          <div>
            <label class="ux-label">Largo (m)</label>
            <input formControlName="largo" class="ux-input" />
          </div>

          <div class="md:col-span-2">
            <label class="ux-label">Tipo de Galp√≥n</label>
            <select formControlName="tipoGalpon" class="ux-input">
              <option value="">Seleccione‚Ä¶</option>
              <option *ngFor="let opt of typegarponOptions" [value]="opt">{{ opt }}</option>
            </select>
          </div>

          <div class="md:col-span-2 ux-actions">
            <button type="button" (click)="modalOpen = false" class="btn-muted">Cancelar</button>
            <button type="submit" [disabled]="form.invalid" class="btn-primary">
              {{ editing ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL: Detalle -->
    <div *ngIf="detailOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="detail-modal-title">
      <div class="ux-modal__panel">
        <div class="ux-modal__header">
          <h2 id="detail-modal-title" class="ux-title">Detalle del Galp√≥n</h2>
          <button type="button" (click)="detailOpen = false" class="btn-muted">Cerrar</button>
        </div>

        <div class="ux-modal__body grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div><strong>ID:</strong> {{ selectedDetail?.galponId }}</div>
          <div><strong>Nombre:</strong> {{ selectedDetail?.galponNombre }}</div>
          <div><strong>N√∫cleo:</strong> {{ getNucleoNameByGalpon(selectedDetail!) }}</div>
          <div><strong>Granja:</strong> {{ getGranjaNameByGalpon(selectedDetail!) }}</div>
          <div><strong>Empresa:</strong> {{ getCompanyNameByGalpon(selectedDetail!) }}</div>
          <div><strong>Ancho (m):</strong> {{ selectedDetail?.ancho }}</div>
          <div><strong>Largo (m):</strong> {{ selectedDetail?.largo }}</div>
          <div><strong>√Årea (m¬≤):</strong> {{ getArea(selectedDetail) }}</div>
          <div><strong>Tipo:</strong> {{ selectedDetail?.tipoGalpon }}</div>
        </div>

        <div class="ux-actions">
          <button type="button" (click)="detailOpen = false" class="btn-primary">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</div>
