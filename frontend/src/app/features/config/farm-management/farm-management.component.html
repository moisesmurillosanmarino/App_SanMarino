<!-- src/app/features/config/farm-management/farm-management.component.html -->
<div class="flex h-screen" [attr.aria-busy]="loading ? 'true' : null">
  <!-- Sidebar -->
  <app-sidebar class="w-64"></app-sidebar>

  <!-- Main -->
  <div class="flex-1 p-6 bg-warm-gray-100 overflow-auto">
    <!-- Header -->
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-6">
      <div class="flex items-center gap-2">
        <fa-icon [icon]="faTractor" class="text-3xl text-brand-red" aria-hidden="true"></fa-icon>
        <h1 class="text-2xl font-bold text-brand-red">Gesti√≥n de Granjas</h1>
        <span class="ml-2 text-xs text-warm-gray-600 bg-white px-2 py-1 rounded border">
          {{ farms.length || 0 }} granja(s)
        </span>
      </div>

      <div class="flex items-center gap-4">
        <!-- Selector de empresa -->
        <div class="flex items-center gap-2">
          <app-company-selector 
            [showLabel]="true"
            size="sm"
            variant="minimal"
            (companyChanged)="onCompanyChanged($event)">
          </app-company-selector>
          
          <!-- Indicador de carga de empresas -->
          <div *ngIf="loadingCompanies" class="flex items-center gap-1 text-xs text-gray-500">
            <div class="spinner spinner--sm"></div>
            <span>Cargando empresas...</span>
          </div>
        </div>

        <button
          (click)="openModal()"
          class="btn-primary"
          aria-label="Nueva granja"
        >
          <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
          Nueva Granja
        </button>
      </div>
    </div>

    <!-- Componente de prueba de integraci√≥n -->
    <div class="mb-6">
      <app-company-test></app-company-test>
    </div>

    <!-- Componente de prueba de endpoints admin -->
    <div class="mb-6">
      <app-company-admin-test></app-company-admin-test>
    </div>

    <!-- Tabla -->
    <div class="ux-card">
      <div class="ux-scroll">
        <table class="ux-table">
          <caption class="sr-only">Listado de granjas</caption>

          <thead>
            <tr>
              <th scope="col">Nombre</th>
              <th scope="col">Empresa</th>
              <th scope="col">Direcci√≥n</th>
              <th scope="col"># N√∫cleos</th>
              <th scope="col" class="text-right">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <!-- Estado: cargando -->
            <tr *ngIf="loading" aria-live="polite">
              <td colspan="5" class="empty-state">
                <div class="inline-flex items-center gap-3">
                  <div class="spinner"></div>
                  Cargando granjas‚Ä¶
                </div>
              </td>
            </tr>

            <!-- Estado: vac√≠o -->
            <tr *ngIf="!loading && (!farms || farms.length === 0)">
              <td colspan="5" class="empty-state">
                <div class="empty-illustration">üè°</div>
                <p>No hay granjas registradas.</p>
                <button (click)="openModal()" class="btn-primary mt-2">
                  <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
                  Crear la primera
                </button>
              </td>
            </tr>

            <!-- Filas -->
            <tr *ngFor="let f of farms" class="ux-row">
              <td>{{ f.name }}</td>
              <td>{{ f.companyId != null ? companyMap[f.companyId] || '‚Äî' : '‚Äî' }}</td>
              <td>{{ f.address || '‚Äî' }}</td>
              <td>{{ f?.nuclei?.length || 0 }}</td>
              <td class="text-right">
                <div class="inline-flex items-center gap-2">
                  <button
                    type="button"
                    class="icon-btn"
                    (click)="openModal(f)"
                    [attr.aria-label]="'Editar ' + f.name"
                    title="Editar"
                  >
                    <fa-icon [icon]="faPen" aria-hidden="true"></fa-icon>
                  </button>

                  <button
                    type="button"
                    class="icon-btn danger"
                    (click)="deleteFarm(f.id!)"
                    [attr.aria-label]="'Eliminar ' + f.name"
                    title="Eliminar"
                  >
                    <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
                  </button>

                  <button
                    type="button"
                    class="icon-btn"
                    (click)="openDetail(f)"
                    [attr.aria-label]="'Ver n√∫cleos de ' + f.name"
                    title="Ver n√∫cleos"
                  >
                    <fa-icon [icon]="faEye" aria-hidden="true"></fa-icon>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>

        </table>
      </div>

      <!-- Overlay de carga sobre la card -->
      <div *ngIf="loading" class="loading-overlay" aria-live="polite">
        <div class="spinner"></div>
        Cargando‚Ä¶
      </div>
    </div>

    <!-- Toast de carga flotante (opcional) -->
    <div *ngIf="loading" class="loading-toast">
      <span class="w-3 h-3 rounded-full bg-brand-red inline-block animate-pulse"></span>
      <span class="ml-2">Procesando‚Ä¶</span>
    </div>
  </div>
</div>

<!-- MODAL: Crear/Editar granja -->
<div
  *ngIf="modalOpen"
  class="fixed inset-0 bg-black/40 backdrop-blur-[1px] flex items-center justify-center z-50"
  role="dialog" aria-modal="true" aria-labelledby="farm-modal-title"
>
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-6 relative animate-[fadeIn_.2s_ease-out]">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <fa-icon [icon]="faTractor" class="text-xl text-brand-red" aria-hidden="true"></fa-icon>
        <h2 id="farm-modal-title" class="text-xl font-bold text-brand-red">
          {{ editing ? 'Editar Granja' : 'Nueva Granja' }}
        </h2>
      </div>
      <button type="button" (click)="closeModal()" class="btn-ghost" aria-label="Cerrar modal">
        Cerrar
      </button>
    </div>

    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="save()" class="space-y-6" novalidate>
      <!-- Datos b√°sicos -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="form-label">Nombre <span class="text-red-600">*</span></label>
          <input formControlName="name" class="form-input" [class.form-input--invalid]="form.get('name')?.invalid && form.get('name')?.touched" />
        </div>

        <div>
          <label class="form-label">Empresa <span class="text-red-600">*</span></label>
          <select formControlName="companyId" class="form-input" [class.form-input--invalid]="form.get('companyId')?.invalid && form.get('companyId')?.touched">
            <option [ngValue]="null" disabled>‚Äî Selecciona empresa ‚Äî</option>
            <option *ngFor="let c of companies" [ngValue]="c.id">{{ c.name }}</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="form-label">Direcci√≥n</label>
          <input formControlName="address" class="form-input" />
        </div>
      </div>

      <!-- N√∫cleos y galpones -->
      <fieldset>
        <legend class="form-label mb-2 font-semibold">N√∫cleos &amp; Galpones</legend>
        <ng-container formArrayName="nuclei">
          <div
            *ngFor="let nucCtrl of nucleiFA.controls; let i = index"
            [formGroupName]="i"
            class="mb-4 p-4 bg-warm-gray-50 rounded-xl border"
          >
            <div class="flex items-center mb-2 gap-2">
              <input
                formControlName="name"
                placeholder="Nombre del N√∫cleo"
                class="form-input flex-1"
                [class.form-input--invalid]="nucCtrl.get('name')?.invalid && nucCtrl.get('name')?.touched"
              />
              <button
                type="button"
                class="icon-btn danger"
                (click)="removeNucleus(i)"
                [attr.aria-label]="'Eliminar n√∫cleo ' + (nucCtrl.get('name')?.value || i + 1)"
                title="Eliminar n√∫cleo"
              >
                <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
              </button>
            </div>

            <div class="pl-2" formArrayName="houses">
              <div
                *ngFor="let houseCtrl of housesFA(i).controls; let hi = index"
                [formGroupName]="hi"
                class="flex items-center mb-2 gap-2"
              >
                <input
                  formControlName="name"
                  placeholder="Nombre del Galp√≥n"
                  class="form-input flex-1"
                  [class.form-input--invalid]="houseCtrl.get('name')?.invalid && houseCtrl.get('name')?.touched"
                />
                <button
                  type="button"
                  class="icon-btn danger"
                  (click)="removeHouse(i, hi)"
                  [attr.aria-label]="'Eliminar galp√≥n ' + (houseCtrl.get('name')?.value || hi + 1)"
                  title="Eliminar galp√≥n"
                >
                  <fa-icon [icon]="faTrash" aria-hidden="true"></fa-icon>
                </button>
              </div>

              <button
                type="button"
                class="btn-ghost mt-1"
                (click)="addHouse(i)"
                [attr.aria-label]="'Agregar galp√≥n al n√∫cleo ' + (nucCtrl.get('name')?.value || i + 1)"
              >
                <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
                Agregar Galp√≥n
              </button>
            </div>
          </div>
        </ng-container>

        <button
          type="button"
          class="btn-ghost"
          (click)="newNucleus()"
          aria-label="Agregar n√∫cleo"
        >
          <fa-icon [icon]="faPlus" aria-hidden="true"></fa-icon>
          Agregar N√∫cleo
        </button>
      </fieldset>

      <!-- Footer acciones -->
      <div class="flex justify-end gap-2">
        <button type="button" class="btn-ghost" (click)="closeModal()">
          <fa-icon [icon]="faTimes" aria-hidden="true"></fa-icon>
          Cancelar
        </button>
        <button type="submit" [disabled]="form.invalid || loading" class="btn-danger disabled:opacity-60 disabled:cursor-not-allowed">
          <fa-icon [icon]="faPen" aria-hidden="true"></fa-icon>
          Guardar
        </button>
      </div>
    </form>

    <!-- Overlay de guardado -->
    <div *ngIf="loading" class="loading-overlay" aria-live="polite">
      <div class="spinner"></div>
      Guardando‚Ä¶
    </div>
  </div>
</div>

<!-- MODAL: Detalle n√∫cleos/galpones (solo lectura) -->
<div
  *ngIf="detailOpen && selectedFarm"
  class="fixed inset-0 bg-black/40 backdrop-blur-[1px] flex items-center justify-center z-50"
  role="dialog" aria-modal="true" aria-labelledby="detail-title"
>
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl p-6 relative animate-[fadeIn_.2s_ease-out]">
    <div class="flex items-center justify-between mb-4">
      <h2 id="detail-title" class="text-xl font-bold text-brand-red">
        N√∫cleos de ‚Äú{{ selectedFarm.name }}‚Äù
      </h2>
      <button type="button" class="btn-ghost" (click)="closeDetail()">
        Cerrar
      </button>
    </div>

    <div *ngFor="let nuc of selectedFarm.nuclei" class="mb-6">
      <div class="font-semibold mb-2">N√∫cleo: {{ nuc.name }}</div>

      <div class="ux-card">
        <div class="ux-scroll" style="max-height: 40vh;">
          <table class="ux-table">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Galp√≥n</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let h of nuc.houses" class="ux-row">
                <td>{{ h.id }}</td>
                <td>{{ h.name }}</td>
              </tr>
              <tr *ngIf="!nuc.houses?.length">
                <td colspan="2" class="empty-state">Sin galpones</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="flex justify-end">
      <button type="button" class="btn-ghost" (click)="closeDetail()">Cerrar</button>
    </div>
  </div>
</div>
